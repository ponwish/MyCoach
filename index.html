<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIã‚³ãƒ¼ãƒãƒ³ã‚° 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* å…¨ä½“ */
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #e0f7fa, #e8f4fd);
      font-family: 'Segoe UI', sans-serif;
    }
  
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
  
    header h1 {
      margin: 0;
      font-size: 1.25rem;
      color: #fff;
    }
  
    #hamburger {
      font-size: 1.5rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
    }
  
    #menu {
      position: absolute;
      top: 60px;
      right: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 999;
    }
  
    #menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
  
    #menu li {
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.2s;
    }
  
    #menu li:hover {
      background: #f1f1f1;
    }
  
    main {
      padding-top: 80px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
  
    .card {
      width: 100%;
      max-width: 420px;
      margin: 20px;
      padding: 24px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
    }
  
    .btn {
      margin-top: 16px;
      border-radius: 30px;
      padding: 12px;
      font-weight: 600;
    }
  
    .btn-primary {
      background: #4facfe;
      border: none;
      color: #fff;
    }
  
    .btn-primary:hover {
      background: #00f2fe;
    }
  
    .btn-success {
      background: #43e97b;
      border: none;
      color: #fff;
    }
  
    .btn-success:hover {
      background: #38d172;
    }
  
   /* âœ… ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¨ãƒªã‚¢ */
#historyList {
  max-height: 500px;
  overflow-y: auto;
  padding: 12px;
}

/* å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¨ä½“ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
.chat-message {
  display: flex;
  justify-content: flex-start;
  margin-bottom: 14px;
}

.chat-message.assistant .chat-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  margin-right: 10px;
  flex-shrink: 0;
  border: 2px solid #4facfe; /* é’ç³»ã®ä¿¡é ¼æ„Ÿã‚ã‚‹è‰²ã§ç¸å–ã‚Š */
  background-color: #fff;    /* ç™½èƒŒæ™¯ã«ã—ã¦æµ®ãã™ããªã„ã‚ˆã†èª¿æ•´ */
}

.chat-message.user .chat-icon {
  display: none;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨AIã§ä½ç½®ã‚’åˆ‡ã‚Šæ›¿ãˆ */
.chat-message.user {
  justify-content: flex-end;
}

.chat-bubble-container {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  max-width: 80%;
}

.chat-message.user .chat-bubble-container {
  align-items: flex-end;
}

/* å¹ãå‡ºã—æœ¬ä½“ */
.chat-bubble {
  padding: 12px 16px;
  border-radius: 18px;
  font-size: 14px;
  line-height: 1.5;
  word-wrap: break-word;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  max-width: 100%;
}

.chat-message.user .chat-bubble {
  background-color: #dcf8c6;
  border-bottom-right-radius: 0;
}

.chat-message.assistant .chat-bubble {
  background-color: #f1f0f0;
  border-bottom-left-radius: 0;
}

/* ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆå¹ãå‡ºã—ä¸‹ï¼‰ */
.chat-timestamp {
  font-size: 11px;
  color: #999;
  margin-top: 4px;
  text-align: right;
}

/* æ—¥ä»˜åŒºåˆ‡ã‚Šãƒ©ãƒ™ãƒ« */
.chat-date-separator {
  text-align: center;
  font-size: 12px;
  color: #666;
  margin: 12px 0;
}

/* ææ¡ˆãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
#suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-bottom: 12px;
}

#suggestions .btn-light {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 20px;
  padding: 6px 12px;
  font-size: 0.85rem;
}

/* å…¥åŠ›é–¢é€£ */
input, select {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 1rem;
}

input:focus, select:focus {
  outline: none;
  border-color: #4facfe;
  box-shadow: 0 0 4px rgba(79, 172, 254, 0.5);
}

.chat-container {
  max-height: 500px;
  overflow-y: auto;
  padding: 10px;
}

.input-group textarea {
  resize: none;
}

#sendButton {
  min-width: 70px;
}

/* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
.fw-bold { font-weight: bold; }
.my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
.small { font-size: 0.875em; }
.text-muted { color: #6c757d; }

/* GPTãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.typing::after {
  content: '...';
  animation: dots 1s steps(3, end) infinite;
}

@keyframes dots {
  0% { content: ''; }
  33% { content: '.'; }
  66% { content: '..'; }
  100% { content: '...'; }
}

  </style>
  
</head>
<body>
  <div id="loginSelector" style="display: none; text-align: center; padding: 2rem;">
    <h2 class="mb-4">ãƒ­ã‚°ã‚¤ãƒ³æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
    <button onclick="loginWithLine()" class="btn btn-success m-2">LINEã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button onclick="loginWithEmail()" class="btn btn-primary m-2">ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    <button onclick="loginWithGoogle()" class="btn btn-danger m-2">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
  <header id="mainHeader" style="display: none;">
    <img src="Resource\image\MyCoach_LOGO.png" alt="MyCoach" id="logo" style="height: 42px; cursor: pointer;" />
    <button id="hamburger">â˜°</button>
  </header>  
  <div id="home-area" class="card" style="display:none;">
    <h4 class="mb-4 text-center">AIã‚³ãƒ¼ãƒãƒ³ã‚° ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
    <button class="btn btn-primary w-100 mb-3" onclick="navigate('chat')">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆã‚’ã¯ã˜ã‚ã‚‹</button>
    <button class="btn btn-success w-100 mb-3" onclick="navigate('coach')">ğŸ‘¨â€ğŸ« ã‚³ãƒ¼ãƒã‚’å¤‰æ›´</button>
    <button class="btn btn-secondary w-100" onclick="navigate('history')">ğŸ“œ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¦‹ã‚‹</button>
    <button class="btn btn-outline-secondary w-100 mb-3" onclick="navigate('goal-edit')">ğŸ¯ ç›®æ¨™ã‚’å¤‰æ›´</button>
  </div>  
  <div id="emailLoginArea" class="card" style="display: none;">
    <h4>ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³</h4>
    <input type="email" id="emailInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
    <button class="btn btn-success mt-2" onclick="submitEmailLogin()">ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡</button>
    <div id="emailLoginMessage" class="mt-3 text-muted small"></div>
  </div> 
  <div id="menu">
    <ul>
      <li onclick="navigate('home')">ãƒ›ãƒ¼ãƒ </li>
      <li onclick="navigate('chat')">ãƒˆãƒ¼ã‚¯</li>
      <li onclick="navigate('coach')">æ‹…å½“å¤‰æ›´</li>
      <li onclick="navigate('history')">å±¥æ­´</li>
      <li onclick="navigate('goal-edit')">ç›®æ¨™ç¢ºèªï¼†å¤‰æ›´</li>
      <li onclick="confirmLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
    </ul>
  </div>
  <main>
    <div class="card" id="goal-area" style="display:none;">
      <h4>ã‚ãªãŸã®ç›®æ¨™ã‚’æ•™ãˆã¦ãã ã•ã„</h4>
      <input type="text" id="goalInput" placeholder="ä¾‹ï¼šTOEIC 900ç‚¹ã‚’ç›®æŒ‡ã™" />
      <button class="btn btn-success" onclick="submitGoal()">ç›®æ¨™ã‚’è¨­å®š</button>
    </div>
    <div id="goal-edit-area" class="card" style="display: none;">
      <h4>ç¾åœ¨ã®ç›®æ¨™</h4>
      <p id="currentGoalText" class="mb-3 text-muted">èª­ã¿è¾¼ã¿ä¸­...</p>
    
      <h5>æ–°ã—ã„ç›®æ¨™ã‚’è¨­å®šã™ã‚‹</h5>
      <input type="text" id="goalEditInput" placeholder="ä¾‹ï¼šTOEIC 900ç‚¹ã‚’ç›®æŒ‡ã™" />
      <button class="btn btn-success mt-3" onclick="submitGoalEdit()">å¤‰æ›´ã‚’ä¿å­˜</button>
    </div>    
    <div class="card" id="chat-area" style="display:none;">
      <!-- ğŸ’¬ ãƒãƒ£ãƒƒãƒˆç”»é¢ä¸Šéƒ¨ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º -->
      <div id="userProfileInfo" class="mb-3 px-3 py-2 border rounded bg-light">
        <div><strong>ğŸ¯ ç›®æ¨™ï¼š</strong><span id="userGoalText">èª­ã¿è¾¼ã¿ä¸­...</span></div>
        <div><strong>ğŸ‘¨â€ğŸ« ã‚³ãƒ¼ãƒï¼š</strong><span id="coachNameText">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      </div>
      <div id="suggestions"></div>
      <div id="chat" class="chat-container"></div>
      <!-- âœ… å…¥åŠ›ã‚¨ãƒªã‚¢ï¼štextareaï¼‹é€ä¿¡ãƒœã‚¿ãƒ³ -->
      <div class="input-group mt-3">
        <textarea id="talkInput" class="form-control" rows="2" placeholder="æ‚©ã¿ã‚„è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰"></textarea>
        <button id="sendButton" class="btn btn-primary" onclick="sendTalk()">é€ä¿¡</button>
      </div>
    </div>
    <div class="card" id="coach-select-area" style="display:none;">
      <h4>æ‹…å½“ã‚³ãƒ¼ãƒã‚’é¸æŠ</h4>
      <select id="coachSelect"><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option></select>
      <button class="btn btn-success" onclick="confirmCoach()">ç¢ºå®š</button>
    </div>
    <!-- å±¥æ­´ã‚¨ãƒªã‚¢ -->
    <div class="card" id="history-area" style="display: none;">
      <h4 class="text-center mb-3">ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h4>
      <select id="historyFilterSelect" class="form-select mb-3">
        <option value="">â€•â€• å…¨ã‚³ãƒ¼ãƒ â€•â€•</option>
      </select>
      <div id="historyList" class="chat-history-container"></div>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'https://mycoach.onrender.com';
    let userId = '';
    let suggestionsShown = false;
    let sessionPollingInterval = null;
    const suggestionTexts = ['ç›®æ¨™ã‚’ç¢ºèªã—ãŸã„','ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸‹ãŒã£ã¦ããŸ'];

    document.addEventListener('DOMContentLoaded', async () => {
  try {
    // âœ… Supabase ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªï¼ˆãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã§ã‚‚ã“ã“ã§å–å¾—å¯ï¼‰
    const { data: { session }, error } = await supabase.auth.getSession();

    if (error) {
      console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error.message);
    }

    if (session?.user) {
      userId = session.user.id;
      localStorage.setItem('supabase-login-success', 'true');
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', userId);
      document.getElementById('mainHeader').style.display = 'flex';  // â† ã“ã‚Œã‚’è¿½åŠ 
      showSection('home');
      return;
    }


    // âœ… LINEãƒ­ã‚°ã‚¤ãƒ³ï¼ˆLIFFï¼‰ç¢ºèª
    await liff.init({ liffId: '2007334673-1dVleAwO' });

    if (liff.isLoggedIn()) {
      const profile = await liff.getProfile();
      userId = profile.userId;

      if (!userId) throw new Error("userIdå–å¾—å¤±æ•—");

      showSection('home');
      return;
    }

    // âœ… ãƒ­ã‚°ã‚¤ãƒ³æœªæ¸ˆï¼šé¸æŠç”»é¢ã‚’è¡¨ç¤º
    document.getElementById('loginSelector').style.display = 'block';

  } catch (err) {
    console.error('ãƒ­ã‚°ã‚¤ãƒ³åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', err);
    alert('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
  }

  startPollingSession();
});

    function startPollingSession() {
      if (sessionPollingInterval) return; // äºŒé‡é˜²æ­¢

      sessionPollingInterval = setInterval(async () => {
        const { data: { session } } = await supabase.auth.getSession();

        if (session?.user) {
          clearInterval(sessionPollingInterval);
          userId = session.user.id;
          showSection('home');
        }
      }, 1000); // 1ç§’ãŠãã«ãƒã‚§ãƒƒã‚¯
    }

    function loginWithLine() {
      if (!liff.isLoggedIn()) {
        liff.login();
      }
    }

    async function loginWithGoogle() {
      await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: location.href
        }
      });
    }

    function loginWithEmail() {
      // Appå†…UIã‚’è¡¨ç¤ºã™ã‚‹æ–¹å¼ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆå¾“æ¥ã®promptã¯ä¸è¦ï¼‰
      document.getElementById('loginSelector').style.display = 'none';
      document.getElementById('emailLoginArea').style.display = 'block';
    }

    async function submitEmailLogin() {
      const email = document.getElementById('emailInput').value.trim();
      const messageEl = document.getElementById('emailLoginMessage');

      if (!email) {
        messageEl.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }

      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: window.location.href  // ç¾åœ¨ã®URLã«æˆ»ã™
        }
      });

      if (error) {
        messageEl.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
      } else {
        messageEl.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
      }
    }



    document.getElementById('talkInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        if (!e.shiftKey) {
          e.preventDefault();           // æ”¹è¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          document.getElementById('suggestions').style.display = 'none';  // ğŸ’¡ã‚ã‚Œã°éè¡¨ç¤º
          sendTalk();                   // é€šå¸¸é€ä¿¡
        }
        // shiftKeyã‚ã‚Šï¼šæ”¹è¡Œã™ã‚‹ã®ã§ä½•ã‚‚ã—ãªã„
      }
    });
    
    window.addEventListener('load', async () => {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (session?.user) {
        alert(`ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ãƒ¦ãƒ¼ã‚¶ID: ${session.user.id}`);
        console.log('ãƒ¦ãƒ¼ã‚¶æƒ…å ±:', session.user);
      } else if (error) {
        alert(`ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      } else {
        console.log('æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹');
      }
    });

    // ğŸ‘‡ 1. ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’æ¤œçŸ¥ï¼ˆåˆ¥ã‚¿ãƒ– â†’ ã“ã®ã‚¿ãƒ–ï¼‰
    window.addEventListener('storage', async (event) => {
      if (event.key === 'supabase-login-success' && event.newValue === 'true') {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) {
          userId = session.user.id;
          localStorage.removeItem('supabase-login-success');  // ãƒ•ãƒ©ã‚°å‰Šé™¤
          showSection('home');
        }
      }
    });

    document.getElementById('hamburger').addEventListener('click', () => {
      const menu = document.getElementById('menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', e => {
      if (!e.target.closest('#menu') && e.target.id !== 'hamburger') {
        document.getElementById('menu').style.display = 'none';
      }
    });

    async function navigate(section) {
      document.getElementById('menu').style.display = 'none';
      await showSection(section);
    }


    function hideAll() {
      ['home-area','goal-area','goal-edit-area','chat-area','coach-select-area','history-area'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    async function showSection(section) {
      hideAll();

      // âœ… ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã®ã¿ãƒ˜ãƒƒãƒ€è¡¨ç¤º
      if (userId) {
        document.getElementById('mainHeader').style.display = 'flex';
      } else {
        document.getElementById('mainHeader').style.display = 'none';
      }

      if (section === 'home') document.getElementById('home-area').style.display = 'block';
      if (section === 'goal') document.getElementById('goal-area').style.display = 'block';
      if (section === 'goal-edit') await loadGoalEdit();
      if (section === 'chat') await checkPrerequisites();
      if (section === 'coach') await loadCoachChange();
      if (section === 'history') await loadHistory();
    }
    document.getElementById('logo').addEventListener('click', () => {
      showSection('home');
    });

    function submitGoal() {
      const goal = document.getElementById('goalInput').value.trim();
      if (!goal) return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      fetch(`${API_BASE_URL}/goal`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ userId, goal })
      }).then(r => r.ok ? showSection('coach') : alert('è¨­å®šå¤±æ•—'));
    }

    async function checkPrerequisites() {
      console.log('ğŸ” checkPrerequisites é–‹å§‹');
      hideAll(); // â† å…ˆã«å…¨éè¡¨ç¤ºåŒ–ã—ã¦ã‹ã‚‰åˆ¶å¾¡ã‚¹ã‚¿ãƒ¼ãƒˆ
      if (!userId) {
        try {
          const profile = await liff.getProfile();
          userId = profile.userId;
          console.log('âœ… LIFF userId:', userId);
        } catch (err) {
          alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          console.error('ğŸ›‘ LIFFã‚¨ãƒ©ãƒ¼:', err);
          return showSection('goal');
        }
      }

      let goal = '';
      try {
        const res = await fetch(`${API_BASE_URL}/user/goal?userId=${userId}`);
        const raw = await res.text();
        console.log('ğŸ“¦ goal raw text:', raw);

        const data = JSON.parse(raw);
        goal = (data?.goal || '').replace(/^[\s\u3000]+|[\s\u3000]+$/g, ''); // åŠè§’/å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹trim

        console.log('ğŸ¯ goal:', goal);
        console.log('ğŸ“¦ goal raw:', data.goal);
        console.log('ğŸ“¦ goal typeof:', typeof data.goal);
        console.log('ğŸ“¦ goal after clean:', goal);
        console.log('ğŸ“¦ goal length:', goal.length);

        document.getElementById('userGoalText').textContent = goal || 'æœªè¨­å®š';
      } catch (err) {
        alert('ãƒãƒ£ãƒƒãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ã¾ãšç›®æ¨™ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚');
        console.error('ğŸ›‘ goalå–å¾—ã‚¨ãƒ©ãƒ¼:', err);
        return showSection('goal');
      }

      if (!goal) {
        alert('ãƒãƒ£ãƒƒãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ã¾ãšç›®æ¨™ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚');
        return showSection('goal');
      }

      let coachName = '';
      try {
        const mapping = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.json());
        const coachList = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
        const coach = coachList.find(c => c.id === mapping.coachId);
        coachName = coach?.name || '';
        document.getElementById('coachNameText').textContent = coachName || 'æœªè¨­å®š';

        if (!mapping.coachId) {
          alert('ãƒãƒ£ãƒƒãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€æ‹…å½“ã‚³ãƒ¼ãƒã®é¸æŠãŒå¿…è¦ã§ã™ã€‚');
          return showSection('coach');
        }
      } catch (err) {
        console.error("ğŸ›‘ ã‚³ãƒ¼ãƒå–å¾—ã‚¨ãƒ©ãƒ¼:", err);
        alert('ãƒãƒ£ãƒƒãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€æ‹…å½“ã‚³ãƒ¼ãƒã®é¸æŠãŒå¿…è¦ã§ã™ã€‚');
        return showSection('coach');
      }

      // âœ… æ¡ä»¶æº€ãŸã—ãŸã®ã§ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º
      console.log('âœ… ç›®æ¨™ãƒ»ã‚³ãƒ¼ãƒãŒæƒã£ãŸã®ã§ãƒãƒ£ãƒƒãƒˆã‚’è¡¨ç¤º');
      document.getElementById('chat-area').style.display = 'block';

      const suggestions = document.getElementById('suggestions');
      if (!suggestionsShown) {
        renderSuggestions();
        suggestions.style.display = 'flex';
        suggestionsShown = true;
      } else {
        suggestions.style.display = 'none';
      }
    }


    function renderSuggestions() {
      const container = document.getElementById('suggestions'); container.innerHTML = ''; 
      suggestionTexts.forEach(text => {
        const btn = document.createElement('button'); btn.className = 'btn btn-light btn-sm'; btn.textContent = text;
        btn.onclick = () => { document.getElementById('talkInput').value = text; document.getElementById('talkInput').focus(); };
        container.appendChild(btn);
      });
    }

    function sendTalk() {
      if (!userId) return alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“');

      const message = document.getElementById('talkInput').value.trim();
      if (!message) return;

      // âœ… ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³éè¡¨ç¤º
      document.getElementById('suggestions').style.display = 'none';

      const chat = document.getElementById('chat');

      // ğŸ’¬ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      const userMsgDiv = document.createElement('div');
      userMsgDiv.className = 'chat-message user';
      userMsgDiv.innerHTML = `
        <div class="chat-bubble-container">
          <div class="chat-bubble">${message}</div>
          <div class="chat-timestamp">${new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
          `;
      chat.appendChild(userMsgDiv);
      document.getElementById('talkInput').value = '';

      // ğŸ”„ GPTã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ–ãƒ«è¿½åŠ 
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message ai-message';
      loadingDiv.id = 'typing-indicator';
      loadingDiv.innerHTML = `<div class="bubble"><span class="typing">...</span></div>`;
      chat.appendChild(loadingDiv);
      chat.scrollTop = chat.scrollHeight;

      console.log('ğŸ“¤ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:', message);

      fetch(`${API_BASE_URL}/talk`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, message })
      })
      .then(res => res.json())
      .then(data => {
        console.log('ğŸ“© ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å¿œç­”:', data);

        // ğŸš§ ãƒã‚§ãƒƒã‚¯æ¡ä»¶
        if (data.requireGoal) {
          alert('ç›®æ¨™è¨­å®šãŒå¿…è¦ã§ã™ã€‚');
          return showSection('goal');
        }
        if (data.requireCoach) {
          alert('ã‚³ãƒ¼ãƒé¸æŠãŒå¿…è¦ã§ã™ã€‚');
          return showSection('coach');
        }

        // â›”ï¸ typingã‚’å‰Šé™¤
        const typingEl = document.getElementById('typing-indicator');
        if (typingEl) typingEl.remove();

        // âœ… GPTã®è¿”ç­”ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!data.message || typeof data.message !== 'string') {
          console.warn('âš ï¸ GPTã‹ã‚‰ã®å¿œç­”ãŒç„¡åŠ¹ã§ã™:', data.message);
          const errorMsg = document.createElement('div');
          errorMsg.className = 'message ai-message';
          errorMsg.innerHTML = `<div class="bubble">âš ï¸ å¿œç­”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
          chat.appendChild(errorMsg);
          return;
        }

        <!-- ğŸ¤– GPTãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰ -->
        const aiMsgDiv = document.createElement('div');
        aiMsgDiv.className = 'chat-message assistant';
        aiMsgDiv.innerHTML = `
          <img src="/Resource/image/coach_icon.png" alt="Coach Icon" class="chat-icon" />
          <div class="chat-bubble-container">
            <div class="chat-bubble">${data.message}</div>
            <div class="chat-timestamp">${new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}</div>
          </div>
        `;
        chat.appendChild(aiMsgDiv);
        chat.scrollTop = chat.scrollHeight;

        console.log('âœ… ãƒãƒ£ãƒƒãƒˆç”»é¢ã«å¿œç­”ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', data.message);
      })
      .catch(error => {
        console.error('ğŸ›‘ fetchã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }


    async function loadCoachChange() {
      hideAll();
      let mapping;
      try { mapping = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.ok ? r.json() : Promise.reject()); } catch { mapping = null; }
      const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
      const select = document.getElementById('coachSelect'); select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      coaches.forEach(c => {
        const opt = document.createElement('option'); opt.value = c.id; opt.text = `${c.code_id} ${c.name}`;
        if (mapping && mapping.coachId === c.id) opt.selected = true;
        select.appendChild(opt);
      });
      document.getElementById('coach-select-area').style.display = 'block';
    }

    function confirmCoach() {
      const coachId = document.getElementById('coachSelect').value;
      if (!coachId) return alert('é¸æŠã—ã¦ãã ã•ã„');
      fetch(`${API_BASE_URL}/user/assign_coach`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, coachId }) })
        .then(res => res.ok && showSection('chat'));
    }

    async function loadHistory() {
      hideAll();
      const filter = document.getElementById('historyFilterSelect');
      if (filter.options.length <= 1) {
        const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
        filter.innerHTML = '<option value="">â€•â€• å…¨ã‚³ãƒ¼ãƒ â€•â€•</option>';
        coaches.forEach(c => filter.appendChild(new Option(`${c.code_id} ${c.name}`, c.id)));
        filter.addEventListener('change', loadHistory);
      }

      const params = new URLSearchParams({ userId });
      if (filter.value) params.append('coachId', filter.value);
      const history = await fetch(`${API_BASE_URL}/user/history?${params}`).then(r => r.json());

      const container = document.getElementById('historyList');
      container.innerHTML = '';

      let lastDate = null;
      history.forEach(msg => {
        const dateObj = new Date(msg.created_at);
        const dateStr = dateObj.toLocaleDateString('ja-JP');
        const timeStr = dateObj.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

        if (lastDate !== dateStr) {
          const dateHeader = document.createElement('div');
          dateHeader.className = 'chat-date-separator';
          dateHeader.textContent = `ğŸ—“ ${dateStr}`;
          container.appendChild(dateHeader);
          lastDate = dateStr;
        }

        const msgWrapper = document.createElement('div');
        msgWrapper.className = `chat-message ${msg.role === 'user' ? 'user' : 'assistant'}`;
        if (msg.role === 'assistant') {
          msgWrapper.innerHTML = `
            <img src="Resource/image/coach_icon.png" alt="Coach Icon" class="chat-icon" />
            <div class="chat-bubble-container">
              <div class="chat-bubble">${msg.content}</div>
              <div class="chat-timestamp">${timeStr}</div>
            </div>
          `;
        } else {
          msgWrapper.innerHTML = `
            <div class="chat-bubble-container">
              <div class="chat-bubble">${msg.content}</div>
              <div class="chat-timestamp">${timeStr}</div>
            </div>
          `;
        }
        container.appendChild(msgWrapper);
      });

      document.getElementById('history-area').style.display = 'block';
    }

    async function loadGoalEdit() {
      try {
        const res = await fetch(`${API_BASE_URL}/user/goal?userId=${userId}`);
        const data = await res.json();
        document.getElementById('currentGoalText').textContent = data.goal || 'æœªè¨­å®š';
        document.getElementById('goalEditInput').value = data.goal || '';
        document.getElementById('goal-edit-area').style.display = 'block';
      } catch (err) {
        alert('ç›®æ¨™ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function submitGoalEdit() {
      const goal = document.getElementById('goalEditInput').value.trim();
      if (!goal) return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

      const res = await fetch(`${API_BASE_URL}/goal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, goal })
      });

      if (res.ok) {
        alert('ç›®æ¨™ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        showSection('home');
      } else {
        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function confirmLogout() {
  if (confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
    logout();
  }
}

    async function logout() {
      try {
        await supabase.auth.signOut();
        if (liff.isLoggedIn()) liff.logout();

        userId = '';
        suggestionsShown = false;

        hideAll();
        document.getElementById('loginSelector').style.display = 'block';
        document.getElementById('mainHeader').style.display = 'none'; // â† ã“ã‚Œã‚’è¿½åŠ 
      } catch (err) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¤±æ•—:', err);
        alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      document.getElementById('userGoalText').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
      document.getElementById('coachNameText').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
      document.getElementById('chat').innerHTML = '';
      document.getElementById('talkInput').value = '';
    }


  </script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://kyxneqqadoyqxsmohbop.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt5eG5lcXFhZG95cXhzbW9oYm9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NjMxNTgsImV4cCI6MjA2MTMzOTE1OH0.g6TmCxkj5iYkrntgBWVNM1RbWjWSr4Owyz7jn_q3dYM'
  );

  window.supabase = supabase; // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ã—ã¦é€šå¸¸ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨é€£æº
</script>
</body>
</html>
