<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>コーチングMini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #e8f4fd; min-height:100vh; padding:0; margin:0; font-family: sans-serif; }
    header { 
      position: fixed; top:0; left:0; right:0; 
      background:#3399ff; color:#fff; height:50px; 
      display:flex; align-items:center; justify-content: space-between;
      padding:0 15px; z-index:2000;
    }
    #hamburger { 
      font-size:24px; background:none; border:none; color:#fff; cursor:pointer;
      z-index:2001;
    }
    #menu { 
      position:absolute; top:50px; right:15px; width:200px; 
      background:#fff; box-shadow:0 4px 8px rgba(0,0,0,0.1);
      display:none; z-index:2000;
    }
    #menu ul { list-style:none; padding:0; margin:0; }
    #menu li { padding:10px; border-bottom:1px solid #eee; cursor:pointer; }
    #menu li:hover { background:#f0f0f0; }
    main { padding-top:60px; display:flex; justify-content:center; }
    .card { 
      width:100%; max-width:400px; margin:10px; padding:20px; 
      background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1);
      text-align:center; 
    }
    .btn { width:100%; margin-top:10px; border-radius:30px; }
    .chat-container { 
      max-height:300px; overflow-y:auto; padding:10px;
      background:#f9f9f9; border-radius:8px; margin-bottom:15px;
    }
    .user-message { text-align:right; margin:5px 0; }
    .user-message span { 
      background:#3399ff; color:#fff; padding:8px;
      border-radius:20px 20px 0 20px; display:inline-block;
      max-width:80%; word-wrap:break-word;
    }
    .ai-message { text-align:left; margin:5px 0; }
    .ai-message span { 
      background:#e0e0e0; color:#333; padding:8px;
      border-radius:20px 20px 20px 0; display:inline-block;
      max-width:80%; word-wrap:break-word;
    }
    #suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:10px; }
    #suggestions .btn-light { font-size:0.8rem; padding:5px 10px; }
    #coachSelect, #historyList { margin-bottom:10px; }
    #currentCoach { font-size:0.9rem; margin-bottom:10px; }
  </style>
</head>
<body>
  <header>
    <h1 style="flex:1; text-align:center; font-size:18px; margin:0;">AIコーチ</h1>
    <button id="hamburger" onclick="toggleMenu()">☰</button>
  </header>
  <div id="menu">
    <ul>
      <li onclick="navigate('chat')">トーク</li>
      <li onclick="navigate('coach')">担当コーチ変更</li>
      <li onclick="navigate('history')">トーク履歴</li>
    </ul>
  </div>
  <main>
    <!-- トーク画面 -->
    <div class="card" id="chat-area" style="display:none;">
      <div id="suggestions"></div>
      <div id="chat" class="chat-container"></div>
      <input type="text" id="talkInput" class="form-control" placeholder="メッセージを入力">
      <button class="btn btn-primary" onclick="sendTalk()">送信</button>
    </div>

    <!-- コーチ変更画面 -->
    <div class="card" id="coach-select-area" style="display:none;">
      <h4>担当コーチを変更</h4>
      <div id="currentCoach">現在の担当コーチ: <strong id="currentCoachName">読み込み中...</strong></div>
      <select id="coachSelect" class="form-select">
        <option value="">-- 選択してください --</option>
      </select>
      <button class="btn btn-success" onclick="confirmCoach()">確定</button>
    </div>

    <!-- トーク履歴画面 -->
    <div class="card" id="history-area" style="display:none;">
      <h4>トーク履歴</h4>
      <div id="historyHeader" class="mb-2 text-muted"></div>
      <div id="historyList" class="chat-container"></div>
    </div>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'https://mycoach.onrender.com';
    let userId = '';
    // サジェスト文一覧
    const suggestionTexts = [
      '最近の気分はどうですか？',
      '今日の目標は何ですか？',
      'チャレンジしたいことは？',
      '何でも相談してください'
    ];
    // LIFF 初期化
    liff.init({ liffId: '2007334673-1dVleAwO' })
      .then(() => !liff.isLoggedIn() ? liff.login() : liff.getProfile())
      .then(profile => { userId = profile.userId; showSection('chat'); })
      .catch(() => showSection('chat'));
    // メニュー制御
    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }
    document.addEventListener('click', e => {
      if (!e.target.closest('#menu') && e.target.id !== 'hamburger') {
        document.getElementById('menu').style.display = 'none';
      }
    });
    // ナビゲーション
    function navigate(section) { toggleMenu(); showSection(section); }
    function hideAll() { ['chat-area','coach-select-area','history-area'].forEach(id => document.getElementById(id).style.display = 'none'); }
    function showSection(section) {
      hideAll();
      if (section === 'chat') {
        document.getElementById('chat-area').style.display = 'block';
        renderSuggestions();
      }
      if (section === 'coach') loadCoachChange();
      if (section === 'history') loadHistory();
    }
    // サジェストチップ描画
    function renderSuggestions() {
      const container = document.getElementById('suggestions');
      container.innerHTML = '';
      suggestionTexts.forEach(text => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-light btn-sm';
        btn.textContent = text;
        btn.onclick = () => {
          document.getElementById('talkInput').value = text;
          document.getElementById('talkInput').focus();
        };
        container.appendChild(btn);
      });
    }
    // チャット送信
    function sendTalk() {
      const msg = document.getElementById('talkInput').value;
      if (!msg) return;
      const chat = document.getElementById('chat');
      const userDiv = document.createElement('div'); userDiv.className = 'user-message'; userDiv.innerHTML = `<span>${msg}</span>`;
      chat.appendChild(userDiv);
      document.getElementById('talkInput').value = '';
      fetch(`${API_BASE_URL}/talk`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, message: msg })})
        .then(res => res.json()).then(data => {
          const aiDiv = document.createElement('div'); aiDiv.className = 'ai-message'; aiDiv.innerHTML = `<span>${data.message}</span>`;
          chat.appendChild(aiDiv); chat.scrollTop = chat.scrollHeight;
        });
    }
    // コーチ変更
    function loadCoachChange() {
      fetch(`${API_BASE_URL}/user/coach?userId=${userId}`)
        .then(res => res.ok ? res.json() : Promise.reject())
        .then(mapping => document.getElementById('currentCoachName').textContent = mapping.coachId)
        .catch(() => document.getElementById('currentCoachName').textContent = '未設定');
      fetch(`${API_BASE_URL}/coaches`)
        .then(res => res.json()).then(list => {
          const sel = document.getElementById('coachSelect'); sel.innerHTML = '<option value="">-- 選択してください --</option>';
          list.forEach(c => sel.add(new Option(`${c.code_id} ${c.name}`, c.id)));
          document.getElementById('coach-select-area').style.display = 'block';
        });
    }
    function confirmCoach() {
      const coachId = document.getElementById('coachSelect').value;
      if (!coachId) return alert('コーチを選択してください');
      fetch(`${API_BASE_URL}/user/assign_coach`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, coachId })})
        .then(res => res.ok && showSection('coach'));
    }
    function loadHistory() {
  // 担当コーチ名取得
  fetch(`${API_BASE_URL}/user/coach?userId=${userId}`)
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(mapping => {
      // プロフィール取得してコーチ名表示
      return fetch(`${API_BASE_URL}/coaches`);
    })
    .then(res => res.json())
    .then(list => {
      const mappingCoach = list.find(c => c.id === mapping.coachId);
      document.getElementById('historyHeader').textContent =
        `担当コーチ: ${mappingCoach ? mappingCoach.code_id + ' ' + mappingCoach.name : '未設定'}`;
    })
    .catch(() => {
      document.getElementById('historyHeader').textContent = '担当コーチ: 未設定';
    });

  // 会話履歴取得
  fetch(`${API_BASE_URL}/user/history?userId=${userId}`)
    .then(res => res.json())
    .then(data => {
      const listEl = document.getElementById('historyList');
      listEl.innerHTML = '';
      data.forEach(msg => {
        const container = document.createElement('div');
        // タイムスタンプ
        const time = document.createElement('div');
        time.className = 'text-center text-muted small mb-1';
        const dt = new Date(msg.created_at);
        time.textContent = dt.toLocaleString('ja-JP', {
          year:'numeric', month:'2-digit', day:'2-digit',
          hour:'2-digit', minute:'2-digit'
        });
        // メッセージバブル
        const bubble = document.createElement('div');
        bubble.className = msg.role === 'user' ? 'user-message' : 'ai-message';
        bubble.innerHTML = `<span>${msg.content}</span>`;
        listEl.appendChild(time);
        listEl.appendChild(bubble);
      });
      document.getElementById('history-area').style.display = 'block';
    })
    .catch(() => alert('履歴の取得に失敗しました'));
}
  </script>
</body>
</html>
