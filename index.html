<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIã‚³ãƒ¼ãƒãƒ³ã‚° 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* å…¨ä½“ */
    body { margin:0; padding:0; background: linear-gradient(135deg,#e0f7fa,#e8f4fd); font-family:'Segoe UI',sans-serif; }
    header { position:fixed; top:0; left:0; right:0; height:60px; background:linear-gradient(90deg,#4facfe,#00f2fe); display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:1000; }
    header h1 { margin:0; font-size:1.25rem; color:#fff; }
    #hamburger { font-size:1.5rem; background:none; border:none; color:#fff; cursor:pointer; }
    #menu { position:absolute; top:60px; right:20px; background:#fff; border-radius:12px; box-shadow:0 8px 16px rgba(0,0,0,0.1); display:none; z-index:999; }
    #menu ul { list-style:none; margin:0; padding:0; }
    #menu li { padding:12px 20px; cursor:pointer; transition:background 0.2s; }
    #menu li:hover { background:#f1f1f1; }
    main { padding-top:80px; display:flex; justify-content:center; flex-wrap:wrap; }
    .card { width:100%; max-width:420px; margin:20px; padding:24px; background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.05); }
    .btn { margin-top:16px; border-radius:30px; padding:12px; font-weight:600; }
    .btn-primary { background:#4facfe; border:none; color:#fff; }
    .btn-primary:hover { background:#00f2fe; }
    .btn-success { background:#43e97b; border:none; color:#fff; }
    .btn-success:hover { background:#38d172; }
    .chat-container { max-height:300px; overflow-y:auto; padding:12px; background:#f8faff; border-radius:12px; margin-bottom:16px; }
    #historyList.chat-container { max-height:600px; }
    .user-message, .ai-message { margin:8px 0; display:flex; }
    .user-message span { background:#4facfe; color:#fff; border-radius:20px 20px 0 20px; padding:10px 16px; margin-left:auto; max-width:75%; word-wrap:break-word; }
    .ai-message span { background:#e1fcf9; color:#333; border-radius:20px 20px 20px 0; padding:10px 16px; margin-right:auto; max-width:75%; word-wrap:break-word; }
    #suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:12px; }
    #suggestions .btn-light { background:#fff; border:1px solid #ddd; border-radius:20px; padding:6px 12px; font-size:0.85rem; }
    input, select { width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
    input:focus, select:focus { outline:none; border-color:#4facfe; box-shadow:0 0 4px rgba(79,172,254,0.5); }
    .chat-container {
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }

    .message {
      display: flex;
      margin-bottom: 10px;
    }

    .bubble {
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
    }

    .user-message {
      justify-content: flex-end;
    }

    .user-message .bubble {
      background: #dcf8c6;
      color: #000;
      border-bottom-right-radius: 0;
    }

    .ai-message {
      justify-content: flex-start;
    }

    .ai-message .bubble {
      background: #f1f0f0;
      color: #000;
      border-bottom-left-radius: 0;
    }

    .input-group textarea {
      resize: none;
    }

    #sendButton {
      min-width: 70px;
    }

    .fw-bold { font-weight: bold; }
    .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .small { font-size: 0.875em; }
    .text-muted { color: #6c757d; }
    .typing::after {
      content: '...';
      animation: dots 1s steps(3, end) infinite;
    }

    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }

  </style>
</head>
<body>
  <header>
    <h1>AIã‚³ãƒ¼ãƒãƒ³ã‚° 2025</h1>
    <button id="hamburger">â˜°</button>
  </header>
  <div id="menu">
    <ul>
      <li onclick="navigate('chat')">ãƒˆãƒ¼ã‚¯</li>
      <li onclick="navigate('coach')">æ‹…å½“å¤‰æ›´</li>
      <li onclick="navigate('history')">å±¥æ­´</li>
    </ul>
  </div>
  <main>
    <div class="card" id="goal-area" style="display:none;">
      <h4>ã‚ãªãŸã®ç›®æ¨™ã‚’æ•™ãˆã¦ãã ã•ã„</h4>
      <input type="text" id="goalInput" placeholder="ä¾‹ï¼šTOEIC 900ç‚¹ã‚’ç›®æŒ‡ã™" />
      <button class="btn btn-success" onclick="submitGoal()">ç›®æ¨™ã‚’è¨­å®š</button>
    </div>
    <div class="card" id="chat-area" style="display:none;">
      <div id="suggestions"></div>
      <div id="chat" class="chat-container"></div>
      <!-- âœ… å…¥åŠ›ã‚¨ãƒªã‚¢ï¼štextareaï¼‹é€ä¿¡ãƒœã‚¿ãƒ³ -->
      <div class="input-group mt-3">
        <textarea id="talkInput" class="form-control" rows="2" placeholder="æ‚©ã¿ã‚„è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰"></textarea>
        <button id="sendButton" class="btn btn-primary" onclick="sendTalk()">é€ä¿¡</button>
      </div>
    </div>
    <div class="card" id="coach-select-area" style="display:none;">
      <h4>æ‹…å½“ã‚³ãƒ¼ãƒã‚’é¸æŠ</h4>
      <select id="coachSelect"><option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option></select>
      <button class="btn btn-success" onclick="confirmCoach()">ç¢ºå®š</button>
    </div>
    <!-- ğŸ’¬ ãƒãƒ£ãƒƒãƒˆç”»é¢ä¸Šéƒ¨ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º -->
    <div id="userProfileInfo" class="mb-3 px-3 py-2 border rounded bg-light">
      <div><strong>ğŸ¯ ç›®æ¨™ï¼š</strong><span id="userGoalText">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><strong>ğŸ‘¨â€ğŸ« ã‚³ãƒ¼ãƒï¼š</strong><span id="coachNameText">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>
    <div class="card" id="history-area" style="display:none;">
      <h4>ãƒˆãƒ¼ã‚¯å±¥æ­´</h4>
      <select id="historyFilterSelect"><option value="">â”€â”€ å…¨ã‚³ãƒ¼ãƒ â”€â”€</option></select>
      <div id="historyList" class="chat-container"></div>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'https://mycoach.onrender.com';
    let userId = '';
    let suggestionsShown = false;
    const suggestionTexts = ['ç›®æ¨™ã‚’ç¢ºèªã—ãŸã„','ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸‹ãŒã£ã¦ããŸ'];

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await liff.init({ liffId: '2007334673-1dVleAwO' });

        if (!liff.isLoggedIn()) {
          await liff.login(); // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã¸
        }

        const profile = await liff.getProfile();
        userId = profile.userId;

        if (!userId) throw new Error("userIdå–å¾—å¤±æ•—");
        showSection('chat');

      } catch (err) {
        console.error('LIFFã‚¨ãƒ©ãƒ¼:', err);
        alert('LINEãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      }
    });

    document.getElementById('talkInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        if (!e.shiftKey) {
          e.preventDefault();           // æ”¹è¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          document.getElementById('suggestions').style.display = 'none';  // ğŸ’¡ã‚ã‚Œã°éè¡¨ç¤º
          sendTalk();                   // é€šå¸¸é€ä¿¡
        }
        // shiftKeyã‚ã‚Šï¼šæ”¹è¡Œã™ã‚‹ã®ã§ä½•ã‚‚ã—ãªã„
      }
    });

    document.getElementById('hamburger').addEventListener('click', () => {
      const menu = document.getElementById('menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', e => {
      if (!e.target.closest('#menu') && e.target.id !== 'hamburger') {
        document.getElementById('menu').style.display = 'none';
      }
    });

    function navigate(section) {
      document.getElementById('menu').style.display = 'none';
      showSection(section);
    }

    function hideAll() {
      ['goal-area','chat-area','coach-select-area','history-area'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    function showSection(section) {
      hideAll();
      if (section === 'chat') checkPrerequisites();
      if (section === 'goal') document.getElementById('goal-area').style.display = 'block';
      if (section === 'coach') loadCoachChange();
      if (section === 'history') loadHistory();
    }

    function submitGoal() {
      const goal = document.getElementById('goalInput').value.trim();
      if (!goal) return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      fetch(`${API_BASE_URL}/goal`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ userId, goal })
      }).then(r => r.ok ? showSection('coach') : alert('è¨­å®šå¤±æ•—'));
    }

    async function checkPrerequisites() {
      if (!userId) {
        try { const p = await liff.getProfile(); userId = p.userId; } catch {}
      }

      let hasGoal = true;
      try {
        const goalRes = await fetch(`${API_BASE_URL}/user/goal?userId=${userId}`).then(r => r.json());
        document.getElementById('userGoalText').textContent = goalRes.goal || 'æœªè¨­å®š';
      } catch {
        hasGoal = false;
      }
      if (!hasGoal) return showSection('goal');

      let hasCoach = true;
      try {
        const coachRes = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.json());
        console.log('ğŸ“¦ ã‚³ãƒ¼ãƒæƒ…å ±:', coachRes); // â† ãƒ‡ãƒãƒƒã‚°è¿½åŠ 
        document.getElementById('coachNameText').textContent = coachRes.name || 'æœªè¨­å®š';
      } catch {
        hasCoach = false;
      }
      if (!hasCoach) return showSection('coach');

      document.getElementById('chat-area').style.display = 'block';
      const suggestions = document.getElementById('suggestions');
      if (!suggestionsShown) { renderSuggestions(); suggestions.style.display = 'flex'; suggestionsShown = true; }
      else { suggestions.style.display = 'none'; }
    }

    function renderSuggestions() {
      const container = document.getElementById('suggestions'); container.innerHTML = ''; 
      suggestionTexts.forEach(text => {
        const btn = document.createElement('button'); btn.className = 'btn btn-light btn-sm'; btn.textContent = text;
        btn.onclick = () => { document.getElementById('talkInput').value = text; document.getElementById('talkInput').focus(); };
        container.appendChild(btn);
      });
    }

    function sendTalk() {
      if (!userId) return alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“');
      document.getElementById('suggestions').style.display = 'none';

      const message = document.getElementById('talkInput').value;
      if (!message) return;

      const chat = document.getElementById('chat');

      // ğŸ’¬ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
      const userMsgDiv = document.createElement('div');
      userMsgDiv.className = 'message user-message';
      userMsgDiv.innerHTML = `<div class="bubble">${message}</div>`;
      chat.appendChild(userMsgDiv);
      document.getElementById('talkInput').value = '';

      // ğŸ”„ GPTã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒãƒ–ãƒ«è¿½åŠ 
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message ai-message';
      loadingDiv.id = 'typing-indicator';
      loadingDiv.innerHTML = `<div class="bubble"><span class="typing">...</span></div>`;
      chat.appendChild(loadingDiv);
      chat.scrollTop = chat.scrollHeight;

      fetch(`${API_BASE_URL}/talk`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, message })
      })
      .then(res => res.json())
      .then(data => {
        if (data.requireGoal) return showSection('goal');
        if (data.requireCoach) return showSection('coach');

        // ğŸ” typingã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰å®Ÿéš›ã®è¿”ç­”ã‚’è¿½åŠ 
        const typingEl = document.getElementById('typing-indicator');
        if (typingEl) typingEl.remove();

        const aiMsgDiv = document.createElement('div');
        aiMsgDiv.className = 'message ai-message';
        aiMsgDiv.innerHTML = `<div class="bubble">${data.message}</div>`;
        chat.appendChild(aiMsgDiv);
        chat.scrollTop = chat.scrollHeight;
      });
    }



    async function loadCoachChange() {
      hideAll();
      let mapping;
      try { mapping = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.ok ? r.json() : Promise.reject()); } catch { mapping = null; }
      const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
      const select = document.getElementById('coachSelect'); select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      coaches.forEach(c => {
        const opt = document.createElement('option'); opt.value = c.id; opt.text = `${c.code_id} ${c.name}`;
        if (mapping && mapping.coachId === c.id) opt.selected = true;
        select.appendChild(opt);
      });
      document.getElementById('coach-select-area').style.display = 'block';
    }

    function confirmCoach() {
      const coachId = document.getElementById('coachSelect').value;
      if (!coachId) return alert('é¸æŠã—ã¦ãã ã•ã„');
      fetch(`${API_BASE_URL}/user/assign_coach`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, coachId }) })
        .then(res => res.ok && showSection('chat'));
    }

    async function loadHistory() {
      hideAll();
      const filter = document.getElementById('historyFilterSelect');
      if (filter.options.length <= 1) {
        const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
        filter.innerHTML = '<option value="">â”€â”€ å…¨ã‚³ãƒ¼ãƒ â”€â”€</option>';
        coaches.forEach(c => filter.appendChild(new Option(`${c.code_id} ${c.name}`, c.id)));
        filter.addEventListener('change', loadHistory);
      }

      const params = new URLSearchParams({ userId });
      if (filter.value) params.append('coachId', filter.value);
      const history = await fetch(`${API_BASE_URL}/user/history?${params}`).then(r => r.json());

      const container = document.getElementById('historyList');
      container.innerHTML = '';

      let lastDate = null;

      history.forEach(msg => {
        const dateObj = new Date(msg.created_at);
        const dateStr = dateObj.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const timeStr = dateObj.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

        if (lastDate !== dateStr) {
          const dateHeader = document.createElement('div');
          dateHeader.className = 'text-center fw-bold text-secondary my-2';
          dateHeader.textContent = `ğŸ“… ${dateStr}`;
          container.appendChild(dateHeader);
          lastDate = dateStr;
        }

        const msgWrapper = document.createElement('div');
        msgWrapper.className = msg.role === 'user' ? 'message user-message' : 'message ai-message';
        msgWrapper.innerHTML = `
          <div class="bubble">
            <div class="mb-1 small text-muted">${timeStr}</div>
            ${msg.content}
          </div>`;
        container.appendChild(msgWrapper);
      });

      document.getElementById('history-area').style.display = 'block';
    }

  </script>
</body>
</html>
