<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ログイン / サインアップ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f8fafc;font-family:'Segoe UI',sans-serif}
    .card{max-width:420px;margin:auto;top:50%;transform:translateY(20%);box-shadow:0 4px 10px rgba(0,0,0,.07)}
    .oauth-btn img{height:20px;margin-right:6px}
  </style>

  <!-- 公開定数 -->
  <script>
    const SUPABASE_URL   = "https://kyxneqqadoyqxsmohbop.supabase.co";
    const LIFF_ID        = "2007334673-1dVleAwO";        /* ← 自分の LIFF ID */
    const FRONTEND_HOME  = "/index.html";
  </script>
</head>
<body>
  <div class="card p-4">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#signinTab">サインイン</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#signupTab">サインアップ</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#oauthLinkTab">メール連携 (Google / LINE)</button></li>
    </ul>

    <div class="tab-content">
      <!-- サインイン -->
      <div class="tab-pane fade show active" id="signinTab">
        <button class="btn btn-outline-secondary w-100 mb-2 oauth-btn" onclick="loginWithGoogle()">
          <img src="https://www.svgrepo.com/show/475656/google-color.svg">Google でサインイン
        </button>        
        <button class="btn btn-outline-success w-100 mb-3 oauth-btn" onclick="liffLogin()">
          <img src="https://www.svgrepo.com/show/473502/line-line.svg">LINE でサインイン
        </button>

        <div class="mb-3"><input id="inEmail"  class="form-control" placeholder="メールアドレス"></div>
        <div class="mb-3"><input id="inPass"   type="password" class="form-control" placeholder="パスワード"></div>
        <button class="btn btn-primary w-100" onclick="emailSignIn()">メールでサインイン</button>
        <div id="inMsg" class="small mt-2"></div>
      </div>

      <!-- サインアップ -->
      <div class="tab-pane fade" id="signupTab">
        <div class="mb-3"><input id="upName"  class="form-control" placeholder="お名前 (任意)"></div>
        <div class="mb-3"><input id="upEmail" class="form-control" placeholder="メールアドレス"></div>
        <div class="mb-3"><input id="upPass"  type="password" class="form-control" placeholder="パスワード (6文字以上)"></div>
        <button class="btn btn-success w-100" onclick="emailSignUp()">メールでサインアップ</button>
        <div id="upMsg" class="small mt-2"></div>
      </div>

      <!-- OAuth メール連携 -->
      <div class="tab-pane fade" id="oauthLinkTab">
        <p class="small text-muted">Google / LINE アカウントをお持ちの場合は、メールアドレスと紐づけて登録できます。</p>
        <div class="mb-3"><input id="linkEmail" class="form-control" placeholder="メールアドレス"></div>
        <button class="btn btn-outline-secondary w-100 mb-2 oauth-btn" onclick="googleEmailLink()">
          <img src="https://www.svgrepo.com/show/475656/google-color.svg">Google と連携
        </button>
        <button class="btn btn-outline-success w-100 oauth-btn" onclick="lineEmailLink()">
          <img src="https://www.svgrepo.com/show/473502/line-line.svg">LINE と連携
        </button>
        <div id="linkMsg" class="small mt-2"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    const supabase = createClient(SUPABASE_URL, "PUBLIC_ANON_KEY");  // ← anon キーに置換
  
    // ✅ Supabase OAuth (Google) のコールバック監視
    supabase.auth.onAuthStateChange(async (_e, sess) => {
      if (!sess) return;
      const email = localStorage.getItem('pendingEmail') || sess.user.email;
      try {
        const r = await fetch('https://mycoach.onrender.com/user/oauth_login', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ authId: sess.user.id, email })
        });
        const j = await r.json();
        if (r.ok) {
          localStorage.setItem('userId', j.userId);
          localStorage.removeItem('pendingEmail');
          location.href = "/index.html";
        } else {
          document.getElementById('linkMsg').textContent = j.error || '失敗';
        }
      } catch {
        document.getElementById('linkMsg').textContent = '通信エラー';
      }
    });
  
    // ✅ メール連携付きGoogleログイン
    function googleEmailLink(){
      const email = linkEmail.value.trim();
      if (!email) return alert('メールを入力');
      localStorage.setItem('pendingEmail', email);
      loginWithGoogle();
    }
  </script>

<script>
  // ✅ グローバルスコープで使えるよう分離（type="module" の外に定義）
  function loginWithGoogle() {
    supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: location.href
      }
    });
  }
</script>

<script>
  const API = 'https://mycoach.onrender.com';

  /* ---------- Supabase Google ---------- */
  function directOAuthGoogle(){
    const redirect = encodeURIComponent(location.origin + FRONTEND_HOME);
    location.href = `${SUPABASE_URL}/auth/v1/authorize?provider=google&redirect_to=${redirect}`;
  }

  /* ---------- LINE (LIFF) ---------- */
  async function liffLogin(){
    await ensureLiffReady();
    if(!liff.isLoggedIn()) liff.login({ redirectUri: location.href });
    else await processLiffProfile();
  }
  async function lineEmailLink(){
    const email = linkEmail.value.trim();
    if(!email) return alert('メールを入力');
    await ensureLiffReady();
    if(!liff.isLoggedIn()) liff.login({ redirectUri: location.href+'?linkEmail='+encodeURIComponent(email) });
    else await processLiffProfile(email);
  }
  async function ensureLiffReady(){
    if(!window.liff || liff.id !== LIFF_ID) await liff.init({ liffId: LIFF_ID });
  }
  async function processLiffProfile(forcedEmail){
    const profile = await liff.getProfile();
    const lineId  = profile.userId;
    const email   = forcedEmail || new URL(location.href).searchParams.get('linkEmail') || '';
    /* API 呼び分け */
    const endpoint = email ? '/user/liff_link' : '/user/liff_login';
    const body     = email ? { lineId,email } : { lineId };
    const r = await fetch(`${API}${endpoint}`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
    });
    const j = await r.json();
    if(r.ok){
      localStorage.setItem('userId', j.userId);
      location.href = FRONTEND_HOME;
    }else alert(j.error||'失敗');
  }

  /* ---------- メール／パスワード ---------- */
  async function emailSignIn(){ /* …既存処理は変わらず… */ }
  async function emailSignUp(){ /* …既存処理は変わらず… */ }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
