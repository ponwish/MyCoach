<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ­ã‚°ã‚¤ãƒ³ / ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f8fafc;font-family:'Segoe UI',sans-serif}
    .card{max-width:420px;margin:auto;top:50%;transform:translateY(20%);box-shadow:0 4px 10px rgba(0,0,0,.07)}
    .oauth-btn img{height:20px;margin-right:6px}
  </style>

  <!-- å…¬é–‹å®šæ•° -->
  <script>
    const SUPABASE_URL   = "https://kyxneqqadoyqxsmohbop.supabase.co";
    const LIFF_ID        = "2007334673-1dVleAwO";        /* â† è‡ªåˆ†ã® LIFF ID */
    const FRONTEND_HOME  = "/index.html";
  </script>
</head>
<body>
  <div class="card p-4">
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#signinTab">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#signupTab">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#oauthLinkTab">ãƒ¡ãƒ¼ãƒ«é€£æº (Google / LINE)</button></li>
    </ul>

    <div class="tab-content">
      <!-- ã‚µã‚¤ãƒ³ã‚¤ãƒ³ -->
      <div class="tab-pane fade show active" id="signinTab">
        <button class="btn btn-outline-secondary w-100 mb-2 oauth-btn" onclick="loginWithGoogle()">
          <img src="https://www.svgrepo.com/show/475656/google-color.svg">Google ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
        </button>        
        <button class="btn btn-outline-success w-100 mb-3 oauth-btn" onclick="liffLogin()">
          <img src="https://www.svgrepo.com/show/473502/line-line.svg">LINE ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³
        </button>

        <div class="mb-3"><input id="inEmail"  class="form-control" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"></div>
        <div class="mb-3"><input id="inPass"   type="password" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"></div>
        <button class="btn btn-primary w-100" onclick="emailSignIn()">ãƒ¡ãƒ¼ãƒ«ã§ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
        <div id="inMsg" class="small mt-2"></div>
      </div>

      <!-- ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— -->
      <div class="tab-pane fade" id="signupTab">
        <div class="mb-3"><input id="upName"  class="form-control" placeholder="ãŠåå‰ (ä»»æ„)"></div>
        <div class="mb-3"><input id="upEmail" class="form-control" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"></div>
        <div class="mb-3"><input id="upPass"  type="password" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (6æ–‡å­—ä»¥ä¸Š)"></div>
        <button class="btn btn-success w-100" onclick="emailSignUp()">ãƒ¡ãƒ¼ãƒ«ã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
        <div id="upMsg" class="small mt-2"></div>
      </div>

      <!-- OAuth ãƒ¡ãƒ¼ãƒ«é€£æº -->
      <div class="tab-pane fade" id="oauthLinkTab">
        <p class="small text-muted">Google / LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®å ´åˆã¯ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ç´ã¥ã‘ã¦ç™»éŒ²ã§ãã¾ã™ã€‚</p>
        <div class="mb-3"><input id="linkEmail" class="form-control" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"></div>
        <button class="btn btn-outline-secondary w-100 mb-2 oauth-btn" onclick="googleEmailLink()">
          <img src="https://www.svgrepo.com/show/475656/google-color.svg">Google ã¨é€£æº
        </button>
        <button class="btn btn-outline-success w-100 oauth-btn" onclick="lineEmailLink()">
          <img src="https://www.svgrepo.com/show/473502/line-line.svg">LINE ã¨é€£æº
        </button>
        <div id="linkMsg" class="small mt-2"></div>
      </div>
    </div>
  </div>

  <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
      const supabase = createClient(SUPABASE_URL, "PUBLIC_ANON_KEY");

      window.supabase = supabase;  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚‚å…¬é–‹

      // âœ… Supabase OAuth (Google) ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç›£è¦–
      supabase.auth.onAuthStateChange(async (_e, sess) => {
        if (!sess) return;

        // âœ… ğŸ‘‡ ã“ã“ã«è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä¸€è‡´ã‚’ç¢ºèªï¼‰
        const sessionEmail = sess.user.email.toLowerCase();
        const pendingEmail = (localStorage.getItem('pendingEmail') || '').toLowerCase();

        if (pendingEmail && pendingEmail !== sessionEmail) {
          alert("Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å…¥åŠ›ã—ãŸãƒ¡ãƒ¼ãƒ«ãŒä¸€è‡´ã—ã¾ã›ã‚“");
          await supabase.auth.signOut();
          return;
        }

        try {
          const r = await fetch('https://mycoach.onrender.com/user/oauth_login', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              authId: sess.user.id,
              email: pendingEmail || sessionEmail
            })
          });
          const j = await r.json();
          if (r.ok) {
            localStorage.setItem('userId', j.userId);
            localStorage.removeItem('pendingEmail');
            location.href = "/index.html";
          } else {
            document.getElementById('linkMsg').textContent = j.error || 'å¤±æ•—';
          }
        } catch {
          document.getElementById('linkMsg').textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
        }
      });
  
    // âœ… ãƒ¡ãƒ¼ãƒ«é€£æºä»˜ãGoogleãƒ­ã‚°ã‚¤ãƒ³
    function googleEmailLink(){
      const email = linkEmail.value.trim();
      if (!email) return alert('ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›');
      localStorage.setItem('pendingEmail', email);
      loginWithGoogle();
    }
  </script>

<script>
  // âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ä½¿ãˆã‚‹ã‚ˆã†åˆ†é›¢ï¼ˆtype="module" ã®å¤–ã«å®šç¾©ï¼‰
  function loginWithGoogle() {
    supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: location.href
      }
    });
  }
</script>

<script>
  const API = 'https://mycoach.onrender.com';

  /* ---------- Supabase Google ---------- */
  function directOAuthGoogle(){
    const redirect = encodeURIComponent(location.origin + FRONTEND_HOME);
    location.href = `${SUPABASE_URL}/auth/v1/authorize?provider=google&redirect_to=${redirect}`;
  }

  /* ---------- LINE (LIFF) ---------- */
  async function liffLogin(){
    await ensureLiffReady();
    if(!liff.isLoggedIn()) liff.login({ redirectUri: location.href });
    else await processLiffProfile();
  }
  async function lineEmailLink(){
    const email = linkEmail.value.trim();
    if(!email) return alert('ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›');
    await ensureLiffReady();
    if(!liff.isLoggedIn()) liff.login({ redirectUri: location.href+'?linkEmail='+encodeURIComponent(email) });
    else await processLiffProfile(email);
  }
  async function ensureLiffReady(){
    if(!window.liff || liff.id !== LIFF_ID) await liff.init({ liffId: LIFF_ID });
  }
  async function processLiffProfile(forcedEmail){
    const profile = await liff.getProfile();
    const lineId  = profile.userId;
    const email   = forcedEmail || new URL(location.href).searchParams.get('linkEmail') || '';
    /* API å‘¼ã³åˆ†ã‘ */
    const endpoint = email ? '/user/liff_link' : '/user/liff_login';
    const body     = email ? { lineId,email } : { lineId };
    const r = await fetch(`${API}${endpoint}`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
    });
    const j = await r.json();
    if(r.ok){
      localStorage.setItem('userId', j.userId);
      location.href = FRONTEND_HOME;
    }else alert(j.error||'å¤±æ•—');
  }

  /* ---------- ãƒ¡ãƒ¼ãƒ«ï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ ---------- */
  async function emailSignIn(){ /* â€¦æ—¢å­˜å‡¦ç†ã¯å¤‰ã‚ã‚‰ãšâ€¦ */ }
  async function emailSignUp(){ /* â€¦æ—¢å­˜å‡¦ç†ã¯å¤‰ã‚ã‚‰ãšâ€¦ */ }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
