<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Admin - コーチプロファイル管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f0f8ff; padding: 30px; }
    .card { max-width: 600px; margin: 0 auto 20px; padding: 20px; border-radius: 16px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1); }
    .form-control, .btn { margin-top: 10px; }
    #profile-list .card { cursor: pointer; }
    .status-true { color: green; font-weight: bold; }
    .status-false { color: red; font-weight: bold; }
  </style>
</head>
<body>

<div class="card">
  <h2 class="text-center">Admin ログイン</h2>
  <div id="login-form">
    <input type="text" id="adminId" class="form-control" placeholder="Admin ID">
    <input type="password" id="adminPassword" class="form-control" placeholder="Password">
    <button class="btn btn-primary w-100" onclick="adminLogin()">ログイン</button>
  </div>
</div>

<div id="admin-area" style="display:none;">

  <!-- コーチ一覧表示 -->
  <div class="card">
    <h4 class="text-center">コーチ一覧</h4>
    <div id="profile-list"></div>
  </div>

  <!-- 新規コーチ追加フォーム -->
  <div class="card">
    <h4 class="text-center">新規コーチ追加</h4>
    <input type="text" id="newName" class="form-control" placeholder="コーチ名">
    <input type="number" id="newAge" class="form-control" placeholder="年齢">
    <input type="text" id="newGender" class="form-control" placeholder="性別">
    <input type="text" id="newJob" class="form-control" placeholder="職業">
    <textarea id="newBackground" class="form-control" placeholder="経歴"></textarea>
    <textarea id="newCertifications" class="form-control" placeholder="資格"></textarea>
    <textarea id="newVision" class="form-control" placeholder="ビジョン"></textarea>
    <button class="btn btn-success w-100" onclick="createProfile()">追加</button>
  </div>

  <!-- コーチ情報編集フォーム -->
  <div id="editForm" class="card" style="display:none;">
    <h4 class="text-center">コーチ情報編集</h4>
    <input type="hidden" id="editId">
    <div class="mb-2"><strong>コーチID: </strong><span id="editCodeId"></span></div>
    <div class="mb-2"><strong>ステータス: </strong><span id="editStatus"></span></div>
    <input type="text" id="editName" class="form-control" placeholder="コーチ名">
    <input type="number" id="editAge" class="form-control" placeholder="年齢">
    <input type="text" id="editGender" class="form-control" placeholder="性別">
    <input type="text" id="editJob" class="form-control" placeholder="職業">
    <textarea id="editBackground" class="form-control" placeholder="経歴"></textarea>
    <textarea id="editCertifications" class="form-control" placeholder="資格"></textarea>
    <textarea id="editVision" class="form-control" placeholder="ビジョン"></textarea>
    <button class="btn btn-primary w-100" onclick="updateProfile()">更新</button>
    <button class="btn btn-warning w-100 mt-2" onclick="softDeleteProfile()">受付停止</button>
  </div>

</div>

<script>
  const API_BASE = 'https://mycoach.onrender.com';

  function adminLogin() {
    const adminId = document.getElementById('adminId').value;
    const adminPassword = document.getElementById('adminPassword').value;
    fetch(`${API_BASE}/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ admin_id: adminId, admin_password: adminPassword })
    })
    .then(res => {
      if (res.ok) {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('admin-area').style.display = 'block';
        fetchProfiles();
      } else {
        alert('ログイン失敗');
      }
    });
  }

  function fetchProfiles() {
    fetch(`${API_BASE}/admin/profiles`, { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById('profile-list');
        list.innerHTML = data.map(p => `
          <div class="card p-2 mb-2" onclick="showEditForm('${p.id}')">
            <div><strong>コーチID:</strong> ${p.code_id || ''}</div>
            <div><strong>名前:</strong> ${p.name || ''}</div>
            <div><strong>ステータス:</strong> <span class="status-${p.availability_status}">${p.availability_status ? '受付中' : '受付停止中'}</span></div>
          </div>
        `).join('');
      });
  }

  function showEditForm(id) {
    fetch(`${API_BASE}/admin/profiles`, { credentials: 'include' })
      .then(res => res.json())
      .then(data => {
        const p = data.find(x => x.id === id);
        document.getElementById('editId').value = p.id;
        document.getElementById('editCodeId').textContent = p.code_id;
        document.getElementById('editStatus').textContent = p.availability_status ? '受付中' : '受付停止中';
        document.getElementById('editName').value = p.name || '';
        document.getElementById('editAge').value = p.age || '';
        document.getElementById('editGender').value = p.gender || '';
        document.getElementById('editJob').value = p.job || '';
        document.getElementById('editBackground').value = p.background || '';
        document.getElementById('editCertifications').value = p.certifications || '';
        document.getElementById('editVision').value = p.vision || '';
        document.getElementById('editForm').style.display = 'block';
      });
  }

  function createProfile() {
    const payload = {
      name: document.getElementById('newName').value,
      age: parseInt(document.getElementById('newAge').value),
      gender: document.getElementById('newGender').value,
      job: document.getElementById('newJob').value,
      background: document.getElementById('newBackground').value,
      certifications: document.getElementById('newCertifications').value,
      vision: document.getElementById('newVision').value
    };
    fetch(`${API_BASE}/admin/profiles`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (res.ok) fetchProfiles(); else alert('追加失敗');
    });
  }

  function updateProfile() {
    const id = document.getElementById('editId').value;
    const payload = {
      name: document.getElementById('editName').value,
      age: parseInt(document.getElementById('editAge').value),
      gender: document.getElementById('editGender').value,
      job: document.getElementById('editJob').value,
      background: document.getElementById('editBackground').value,
      certifications: document.getElementById('editCertifications').value,
      vision: document.getElementById('editVision').value
    };
    fetch(`${API_BASE}/admin/profiles/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (res.ok) { fetchProfiles(); document.getElementById('editForm').style.display = 'none'; } else alert('更新失敗');
    });
  }

  function softDeleteProfile() {
    const id = document.getElementById('editId').value;
    fetch(`${API_BASE}/admin/profiles/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ availability_status: false })
    })
    .then(res => {
      if (res.ok) { fetchProfiles(); document.getElementById('editForm').style.display = 'none'; } else alert('ステータス変更失敗');
    });
  }
</script>

</body>
</html>
