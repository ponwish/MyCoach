<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIコーチング 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* 全体 */
    body { margin:0; padding:0; background: linear-gradient(135deg,#e0f7fa,#e8f4fd); font-family:'Segoe UI',sans-serif; }
    header { position:fixed; top:0; left:0; right:0; height:60px; background:linear-gradient(90deg,#4facfe,#00f2fe); display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); z-index:1000; }
    header h1 { margin:0; font-size:1.25rem; color:#fff; }
    #hamburger { font-size:1.5rem; background:none; border:none; color:#fff; cursor:pointer; }
    #menu { position:absolute; top:60px; right:20px; background:#fff; border-radius:12px; box-shadow:0 8px 16px rgba(0,0,0,0.1); display:none; z-index:999; }
    #menu ul { list-style:none; margin:0; padding:0; }
    #menu li { padding:12px 20px; cursor:pointer; transition:background 0.2s; }
    #menu li:hover { background:#f1f1f1; }
    main { padding-top:80px; display:flex; justify-content:center; flex-wrap:wrap; }
    .card { width:100%; max-width:420px; margin:20px; padding:24px; background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.05); }
    .btn { margin-top:16px; border-radius:30px; padding:12px; font-weight:600; }
    .btn-primary { background:#4facfe; border:none; color:#fff; }
    .btn-primary:hover { background:#00f2fe; }
    .btn-success { background:#43e97b; border:none; color:#fff; }
    .btn-success:hover { background:#38d172; }
    .chat-container { max-height:300px; overflow-y:auto; padding:12px; background:#f8faff; border-radius:12px; margin-bottom:16px; }
    #historyList.chat-container { max-height:600px; }
    .user-message, .ai-message { margin:8px 0; display:flex; }
    .user-message span { background:#4facfe; color:#fff; border-radius:20px 20px 0 20px; padding:10px 16px; margin-left:auto; max-width:75%; word-wrap:break-word; }
    .ai-message span { background:#e1fcf9; color:#333; border-radius:20px 20px 20px 0; padding:10px 16px; margin-right:auto; max-width:75%; word-wrap:break-word; }
    #suggestions { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:12px; }
    #suggestions .btn-light { background:#fff; border:1px solid #ddd; border-radius:20px; padding:6px 12px; font-size:0.85rem; }
    input, select { width:100%; padding:12px; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
    input:focus, select:focus { outline:none; border-color:#4facfe; box-shadow:0 0 4px rgba(79,172,254,0.5); }
    .chat-container {
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
    }

    .message {
      display: flex;
      margin-bottom: 10px;
    }

    .bubble {
      padding: 10px 14px;
      border-radius: 18px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 14px;
    }

    .user-message {
      justify-content: flex-end;
    }

    .user-message .bubble {
      background: #dcf8c6;
      color: #000;
      border-bottom-right-radius: 0;
    }

    .ai-message {
      justify-content: flex-start;
    }

    .ai-message .bubble {
      background: #f1f0f0;
      color: #000;
      border-bottom-left-radius: 0;
    }

    .input-group textarea {
      resize: none;
    }

    #sendButton {
      min-width: 70px;
    }

    .fw-bold { font-weight: bold; }
    .my-2 { margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .small { font-size: 0.875em; }
    .text-muted { color: #6c757d; }
    .typing::after {
      content: '...';
      animation: dots 1s steps(3, end) infinite;
    }

    @keyframes dots {
      0% { content: ''; }
      33% { content: '.'; }
      66% { content: '..'; }
      100% { content: '...'; }
    }

  </style>
</head>
<body>
  <header>
    <h1>AIコーチング 2025</h1>
    <button id="hamburger">☰</button>
  </header>
  <div id="menu">
    <ul>
      <li onclick="navigate('chat')">トーク</li>
      <li onclick="navigate('coach')">担当変更</li>
      <li onclick="navigate('history')">履歴</li>
    </ul>
  </div>
  <main>
    <div class="card" id="goal-area" style="display:none;">
      <h4>あなたの目標を教えてください</h4>
      <input type="text" id="goalInput" placeholder="例：TOEIC 900点を目指す" />
      <button class="btn btn-success" onclick="submitGoal()">目標を設定</button>
    </div>
    <div class="card" id="chat-area" style="display:none;">
      <div id="suggestions"></div>
      <div id="chat" class="chat-container"></div>
      <!-- ✅ 入力エリア：textarea＋送信ボタン -->
      <div class="input-group mt-3">
        <textarea id="talkInput" class="form-control" rows="2" placeholder="悩みや質問を入力してください（Shift+Enterで改行）"></textarea>
        <button id="sendButton" class="btn btn-primary" onclick="sendTalk()">送信</button>
      </div>
    </div>
    <div class="card" id="coach-select-area" style="display:none;">
      <h4>担当コーチを選択</h4>
      <select id="coachSelect"><option value="">-- 選択してください --</option></select>
      <button class="btn btn-success" onclick="confirmCoach()">確定</button>
    </div>
    <!-- 💬 チャット画面上部：ユーザー情報表示 -->
    <div id="userProfileInfo" class="mb-3 px-3 py-2 border rounded bg-light">
      <div><strong>🎯 目標：</strong><span id="userGoalText">読み込み中...</span></div>
      <div><strong>👨‍🏫 コーチ：</strong><span id="coachNameText">読み込み中...</span></div>
    </div>
    <div class="card" id="history-area" style="display:none;">
      <h4>トーク履歴</h4>
      <select id="historyFilterSelect"><option value="">── 全コーチ ──</option></select>
      <div id="historyList" class="chat-container"></div>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'https://mycoach.onrender.com';
    let userId = '';
    let suggestionsShown = false;
    const suggestionTexts = ['目標を確認したい','モチベーションが下がってきた'];

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await liff.init({ liffId: '2007334673-1dVleAwO' });

        if (!liff.isLoggedIn()) {
          await liff.login(); // 未ログインならログインへ
        }

        const profile = await liff.getProfile();
        userId = profile.userId;

        if (!userId) throw new Error("userId取得失敗");
        showSection('chat');

      } catch (err) {
        console.error('LIFFエラー:', err);
        alert('LINEログインに失敗しました。再読み込みしてください。');
      }
    });

    document.getElementById('talkInput').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        if (!e.shiftKey) {
          e.preventDefault();           // 改行をキャンセル
          document.getElementById('suggestions').style.display = 'none';  // 💡あれば非表示
          sendTalk();                   // 通常送信
        }
        // shiftKeyあり：改行するので何もしない
      }
    });

    document.getElementById('hamburger').addEventListener('click', () => {
      const menu = document.getElementById('menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', e => {
      if (!e.target.closest('#menu') && e.target.id !== 'hamburger') {
        document.getElementById('menu').style.display = 'none';
      }
    });

    function navigate(section) {
      document.getElementById('menu').style.display = 'none';
      showSection(section);
    }

    function hideAll() {
      ['goal-area','chat-area','coach-select-area','history-area'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    function showSection(section) {
      hideAll();
      if (section === 'chat') checkPrerequisites();
      if (section === 'goal') document.getElementById('goal-area').style.display = 'block';
      if (section === 'coach') loadCoachChange();
      if (section === 'history') loadHistory();
    }

    function submitGoal() {
      const goal = document.getElementById('goalInput').value.trim();
      if (!goal) return alert('目標を入力してください');
      fetch(`${API_BASE_URL}/goal`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ userId, goal })
      }).then(r => r.ok ? showSection('coach') : alert('設定失敗'));
    }

    async function checkPrerequisites() {
      if (!userId) {
        try { const p = await liff.getProfile(); userId = p.userId; } catch {}
      }

      let hasGoal = true;
      try {
        const goalRes = await fetch(`${API_BASE_URL}/user/goal?userId=${userId}`).then(r => r.json());
        document.getElementById('userGoalText').textContent = goalRes.goal || '未設定';
      } catch {
        hasGoal = false;
      }
      if (!hasGoal) return showSection('goal');

      let hasCoach = true;
      try {
        const coachRes = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.json());
        console.log('📦 コーチ情報:', coachRes); // ← デバッグ追加
        document.getElementById('coachNameText').textContent = coachRes.name || '未設定';
      } catch {
        hasCoach = false;
      }
      if (!hasCoach) return showSection('coach');

      document.getElementById('chat-area').style.display = 'block';
      const suggestions = document.getElementById('suggestions');
      if (!suggestionsShown) { renderSuggestions(); suggestions.style.display = 'flex'; suggestionsShown = true; }
      else { suggestions.style.display = 'none'; }
    }

    function renderSuggestions() {
      const container = document.getElementById('suggestions'); container.innerHTML = ''; 
      suggestionTexts.forEach(text => {
        const btn = document.createElement('button'); btn.className = 'btn btn-light btn-sm'; btn.textContent = text;
        btn.onclick = () => { document.getElementById('talkInput').value = text; document.getElementById('talkInput').focus(); };
        container.appendChild(btn);
      });
    }

    function sendTalk() {
      if (!userId) return alert('ユーザー情報が取得できていません');
      document.getElementById('suggestions').style.display = 'none';

      const message = document.getElementById('talkInput').value;
      if (!message) return;

      const chat = document.getElementById('chat');

      // 💬 ユーザーメッセージ表示
      const userMsgDiv = document.createElement('div');
      userMsgDiv.className = 'message user-message';
      userMsgDiv.innerHTML = `<div class="bubble">${message}</div>`;
      chat.appendChild(userMsgDiv);
      document.getElementById('talkInput').value = '';

      // 🔄 GPTのローディングバブル追加
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'message ai-message';
      loadingDiv.id = 'typing-indicator';
      loadingDiv.innerHTML = `<div class="bubble"><span class="typing">...</span></div>`;
      chat.appendChild(loadingDiv);
      chat.scrollTop = chat.scrollHeight;

      fetch(`${API_BASE_URL}/talk`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, message })
      })
      .then(res => res.json())
      .then(data => {
        if (data.requireGoal) return showSection('goal');
        if (data.requireCoach) return showSection('coach');

        // 🔁 typingを削除してから実際の返答を追加
        const typingEl = document.getElementById('typing-indicator');
        if (typingEl) typingEl.remove();

        const aiMsgDiv = document.createElement('div');
        aiMsgDiv.className = 'message ai-message';
        aiMsgDiv.innerHTML = `<div class="bubble">${data.message}</div>`;
        chat.appendChild(aiMsgDiv);
        chat.scrollTop = chat.scrollHeight;
      });
    }



    async function loadCoachChange() {
      hideAll();
      let mapping;
      try { mapping = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.ok ? r.json() : Promise.reject()); } catch { mapping = null; }
      const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
      const select = document.getElementById('coachSelect'); select.innerHTML = '<option value="">-- 選択してください --</option>';
      coaches.forEach(c => {
        const opt = document.createElement('option'); opt.value = c.id; opt.text = `${c.code_id} ${c.name}`;
        if (mapping && mapping.coachId === c.id) opt.selected = true;
        select.appendChild(opt);
      });
      document.getElementById('coach-select-area').style.display = 'block';
    }

    function confirmCoach() {
      const coachId = document.getElementById('coachSelect').value;
      if (!coachId) return alert('選択してください');
      fetch(`${API_BASE_URL}/user/assign_coach`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, coachId }) })
        .then(res => res.ok && showSection('chat'));
    }

    async function loadHistory() {
      hideAll();
      const filter = document.getElementById('historyFilterSelect');
      if (filter.options.length <= 1) {
        const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
        filter.innerHTML = '<option value="">── 全コーチ ──</option>';
        coaches.forEach(c => filter.appendChild(new Option(`${c.code_id} ${c.name}`, c.id)));
        filter.addEventListener('change', loadHistory);
      }

      const params = new URLSearchParams({ userId });
      if (filter.value) params.append('coachId', filter.value);
      const history = await fetch(`${API_BASE_URL}/user/history?${params}`).then(r => r.json());

      const container = document.getElementById('historyList');
      container.innerHTML = '';

      let lastDate = null;

      history.forEach(msg => {
        const dateObj = new Date(msg.created_at);
        const dateStr = dateObj.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const timeStr = dateObj.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });

        if (lastDate !== dateStr) {
          const dateHeader = document.createElement('div');
          dateHeader.className = 'text-center fw-bold text-secondary my-2';
          dateHeader.textContent = `📅 ${dateStr}`;
          container.appendChild(dateHeader);
          lastDate = dateStr;
        }

        const msgWrapper = document.createElement('div');
        msgWrapper.className = msg.role === 'user' ? 'message user-message' : 'message ai-message';
        msgWrapper.innerHTML = `
          <div class="bubble">
            <div class="mb-1 small text-muted">${timeStr}</div>
            ${msg.content}
          </div>`;
        container.appendChild(msgWrapper);
      });

      document.getElementById('history-area').style.display = 'block';
    }

  </script>
</body>
</html>
