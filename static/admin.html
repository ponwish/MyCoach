<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Admin - ã‚³ãƒ¼ãƒãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f0f8ff; padding: 30px; }
    .card { max-width: 600px; margin: 0 auto 20px; padding: 20px; border-radius: 16px; box-shadow: 0px 4px 8px rgba(0,0,0,0.1); }
    .form-control, .btn { margin-top: 10px; }
    #profile-list .card { cursor: pointer; }
    .status-true { color: green; font-weight: bold; }
    .status-false { color: red; font-weight: bold; }
  </style>
</head>
<body>

<div class="card">
  <h2 class="text-center">Admin ãƒ­ã‚°ã‚¤ãƒ³</h2>
  <div id="login-form">
    <input type="text" id="adminId" class="form-control" placeholder="Admin ID">
    <input type="password" id="adminPassword" class="form-control" placeholder="Password">
    <button class="btn btn-primary w-100" onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
</div>

<div id="admin-area" style="display:none;">

<!-- ğŸ” ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ  -->
<div class="card">
  <h5>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h5>
  <input type="text" id="filterName" class="form-control" placeholder="åå‰ã§æ¤œç´¢" oninput="applyFilter()">
  <select id="filterStatus" class="form-control mt-2" onchange="applyFilter()">
    <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
    <option value="true">å—ä»˜ä¸­ã®ã¿</option>
    <option value="false">å—ä»˜åœæ­¢ä¸­ã®ã¿</option>
  </select>
</div>

  <!-- ã‚³ãƒ¼ãƒä¸€è¦§è¡¨ç¤º -->
  <div class="card">
    <h4 class="text-center">ã‚³ãƒ¼ãƒä¸€è¦§</h4>
    <div id="profile-list"></div>
  </div>

<!-- ğŸ” æ–°è¦ã‚³ãƒ¼ãƒç™»éŒ²ã‚¨ãƒªã‚¢ -->
<div class="card mt-4" id="coach-signup-area">
  <h5 class="mb-3">æ–°è¦ã‚³ãƒ¼ãƒç™»éŒ²</h5>
  <input type="text" id="coachName" placeholder="åå‰" class="form-control mb-2" />
  <input type="email" id="coachEmail" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="form-control mb-2" />
  <input type="password" id="coachPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" class="form-control mb-2" />
  <button class="btn btn-success w-100" onclick="registerCoach()">ç™»éŒ²ã™ã‚‹</button>
  <div id="signupResult" class="small mt-2 text-muted"></div>
</div>


  <!-- æ–°è¦ã‚³ãƒ¼ãƒè¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card">
    <h4 class="text-center">æ–°è¦ã‚³ãƒ¼ãƒè¿½åŠ </h4>
    <input type="text" id="newName" class="form-control" placeholder="ã‚³ãƒ¼ãƒå">
    <input type="number" id="newAge" class="form-control" placeholder="å¹´é½¢">
    <input type="text" id="newGender" class="form-control" placeholder="æ€§åˆ¥">
    <input type="text" id="newJob" class="form-control" placeholder="è·æ¥­">
    <textarea id="newBackground" class="form-control" placeholder="çµŒæ­´"></textarea>
    <textarea id="newCertifications" class="form-control" placeholder="è³‡æ ¼"></textarea>
    <textarea id="newVision" class="form-control" placeholder="ãƒ“ã‚¸ãƒ§ãƒ³"></textarea>
    <button class="btn btn-success w-100" onclick="createProfile()">è¿½åŠ </button>
  </div>

  <!-- ã‚³ãƒ¼ãƒæƒ…å ±ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div id="editForm" class="card" style="display:none;">
    <h4 class="text-center">ã‚³ãƒ¼ãƒæƒ…å ±ç·¨é›†</h4>
    <input type="hidden" id="editId">
    <div class="mb-2"><strong>ã‚³ãƒ¼ãƒID: </strong><span id="editCodeId"></span></div>
    <div class="mb-2"><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: </strong><span id="editStatus"></span></div>
    <input type="text" id="editName" class="form-control" placeholder="ã‚³ãƒ¼ãƒå">
    <input type="number" id="editAge" class="form-control" placeholder="å¹´é½¢">
    <input type="text" id="editGender" class="form-control" placeholder="æ€§åˆ¥">
    <input type="text" id="editJob" class="form-control" placeholder="è·æ¥­">
    <textarea id="editBackground" class="form-control" placeholder="çµŒæ­´"></textarea>
    <textarea id="editCertifications" class="form-control" placeholder="è³‡æ ¼"></textarea>
    <textarea id="editVision" class="form-control" placeholder="ãƒ“ã‚¸ãƒ§ãƒ³"></textarea>
    <button class="btn btn-primary w-100" onclick="updateProfile()">æ›´æ–°</button>
    <button class="btn btn-secondary w-100 mt-2" onclick="toggleAvailability()">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ‡æ›¿</button>
  </div>

  <div class="mt-3">
    <h6>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ãƒ­ã‚°</h6>
    <ul id="logList" class="list-group small"></ul>
  </div>
  

</div>

<script>
  const API_BASE = 'https://mycoach.onrender.com';

  function adminLogin() {
    const adminId = document.getElementById('adminId').value;
    const adminPassword = document.getElementById('adminPassword').value;
    fetch(`${API_BASE}/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ admin_id: adminId, admin_password: adminPassword })
    })
    .then(res => {
      if (res.ok) {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('admin-area').style.display = 'block';
        fetchProfiles();
      } else {
        alert('ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
      }
    });
  }

  function fetchProfiles() {
  fetch(`${API_BASE}/admin/profiles`, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      allProfiles = data;
      applyFilter(); // åˆå›è¡¨ç¤ºæ™‚ã‚‚ãƒ•ã‚£ãƒ«ã‚¿ã‚’é€šã™
    });
}

function applyFilter() {
  const nameFilter = document.getElementById('filterName').value.toLowerCase();
  const statusFilter = document.getElementById('filterStatus').value;
  const list = document.getElementById('profile-list');

  const filtered = allProfiles.filter(p => {
    const matchesName = p.name?.toLowerCase().includes(nameFilter);
    const matchesStatus = statusFilter === '' || String(p.availability_status) === statusFilter;
    return matchesName && matchesStatus;
  });

  list.innerHTML = filtered.map(p => `
    <div class="card p-2 mb-2" onclick="showEditForm('${p.id}')">
      <div><strong>ã‚³ãƒ¼ãƒID:</strong> ${p.code_id || ''}</div>
      <div><strong>åå‰:</strong> ${p.name || ''}</div>
      <div><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> <span class="status-${p.availability_status}">${p.availability_status ? 'å—ä»˜ä¸­' : 'å—ä»˜åœæ­¢ä¸­'}</span></div>
    </div>
  `).join('');
}

function showEditForm(id) {
  fetch(`${API_BASE}/admin/profiles`, { credentials: 'include' })
    .then(res => res.json())
    .then(data => {
      const p = data.find(x => x.id === id);
      document.getElementById('editId').value = p.id;
      document.getElementById('editCodeId').textContent = p.code_id;
      document.getElementById('editStatus').textContent = p.availability_status ? 'å—ä»˜ä¸­' : 'å—ä»˜åœæ­¢ä¸­';
      document.getElementById('editName').value = p.name || '';
      document.getElementById('editAge').value = p.age || '';
      document.getElementById('editGender').value = p.gender || '';
      document.getElementById('editJob').value = p.job || '';
      document.getElementById('editBackground').value = p.background || '';
      document.getElementById('editCertifications').value = p.certifications || '';
      document.getElementById('editVision').value = p.vision || '';
      document.getElementById('editForm').style.display = 'block';

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ­ã‚°å–å¾—
      fetch(`${API_BASE}/admin/status_logs/${p.id}`, { credentials: 'include' })
        .then(res => res.json())
        .then(logs => {
          const logList = document.getElementById('logList');
          logList.innerHTML = logs.map(log => `
            <li class="list-group-item">
              ${log.changed_at ? new Date(log.changed_at).toLocaleString('ja-JP') : ''}ï¼š
              ${log.previous_status ? 'å—ä»˜ä¸­' : 'å—ä»˜åœæ­¢ä¸­'} â†’ ${log.new_status ? 'å—ä»˜ä¸­' : 'å—ä»˜åœæ­¢ä¸­'}
            </li>
          `).join('');
        });
    });
}

async function registerCoach() {
  const name = document.getElementById('coachName').value.trim();
  const email = document.getElementById('coachEmail').value.trim();
  const password = document.getElementById('coachPassword').value;
  const resultEl = document.getElementById('signupResult');

  if (!name || !email || !password) {
    resultEl.textContent = 'å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
    return;
  }

  const res = await fetch('/coach/register', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, password })
  });

  const data = await res.json();
  resultEl.textContent = data.message || data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
}


  function createProfile() {
    const payload = {
      name: document.getElementById('newName').value,
      age: parseInt(document.getElementById('newAge').value),
      gender: document.getElementById('newGender').value,
      job: document.getElementById('newJob').value,
      background: document.getElementById('newBackground').value,
      certifications: document.getElementById('newCertifications').value,
      vision: document.getElementById('newVision').value
    };
    fetch(`${API_BASE}/admin/profiles`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (res.ok) fetchProfiles(); else alert('è¿½åŠ å¤±æ•—');
    });
  }

  function updateProfile() {
    const id = document.getElementById('editId').value;
    const payload = {
      name: document.getElementById('editName').value,
      age: parseInt(document.getElementById('editAge').value),
      gender: document.getElementById('editGender').value,
      job: document.getElementById('editJob').value,
      background: document.getElementById('editBackground').value,
      certifications: document.getElementById('editCertifications').value,
      vision: document.getElementById('editVision').value
    };
    fetch(`${API_BASE}/admin/profiles/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    })
    .then(res => {
      if (res.ok) { fetchProfiles(); document.getElementById('editForm').style.display = 'none'; } else alert('æ›´æ–°å¤±æ•—');
    });
  }

  function reviveProfile() {
  const id = document.getElementById('editId').value;
  fetch(`${API_BASE}/admin/profiles/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ availability_status: true })
  })
  .then(res => {
    if (res.ok) {
      fetchProfiles();
      document.getElementById('editForm').style.display = 'none';
    } else {
      alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å¤±æ•—');
    }
  });
}

  function softDeleteProfile() {
    const id = document.getElementById('editId').value;
    fetch(`${API_BASE}/admin/profiles/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ availability_status: false })
    })
    .then(res => {
      if (res.ok) { fetchProfiles(); document.getElementById('editForm').style.display = 'none'; } else alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å¤±æ•—');
    });
  }

  function toggleAvailability() {
  const id = document.getElementById('editId').value;
  const currentStatus = document.getElementById('editStatus').textContent.trim() === 'å—ä»˜ä¸­';
  const newStatus = !currentStatus;

  fetch(`${API_BASE}/admin/profiles/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify({ availability_status: newStatus })
  })
  .then(res => {
    if (res.ok) {
      fetchProfiles();
      document.getElementById('editForm').style.display = 'none';
    } else {
      alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´å¤±æ•—');
    }
  });
}
  
</script>

</body>
</html>
