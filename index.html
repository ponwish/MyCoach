<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIã‚³ãƒ¼ãƒãƒ³ã‚°Â Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ===== ãƒ™ãƒ¼ã‚¹ ===== */
    body{margin:0;padding:0;background:linear-gradient(135deg,#e0f7fa,#e8f4fd);font-family:'Segoe UI',sans-serif;}
    header{position:fixed;top:0;left:0;right:0;height:60px;background:linear-gradient(90deg,#4facfe,#00f2fe);
      display:flex;align-items:center;justify-content:space-between;padding:0 20px;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:1000;}
    header h1{margin:0;font-size:1.25rem;color:#fff;cursor:pointer;}
    #hamburger{font-size:1.5rem;background:none;border:none;color:#fff;cursor:pointer;}
    #menu{position:absolute;top:60px;right:20px;background:#fff;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.1);display:none;z-index:999;}
    #menu ul{list-style:none;margin:0;padding:0;}
    #menu li{padding:12px 20px;cursor:pointer;transition:background .2s;}
    #menu li:hover{background:#f1f1f1;}

    main{padding-top:80px;display:flex;justify-content:center;flex-wrap:wrap;}
    .card{width:100%;max-width:420px;margin:20px;padding:24px;background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05);}
    .btn{margin-top:16px;border-radius:30px;padding:12px;font-weight:600;}
    .btn-primary{background:#4facfe;border:none;color:#fff;}
    .btn-primary:hover{background:#00f2fe;}
    .btn-success{background:#43e97b;border:none;color:#fff;}
    .btn-success:hover{background:#38d172;}

    /* ===== ãƒãƒ£ãƒƒãƒˆé–¢é€£ ===== */
    #historyList{max-height:500px;overflow-y:auto;padding:12px;}
    .chat-message{display:flex;justify-content:flex-start;margin-bottom:14px;}
    .chat-icon{width:36px;height:36px;border-radius:50%;border:2px solid #4facfe;background:#fff;object-fit:cover;}
    .chat-message.user .chat-icon{display:none;}
    .chat-message.user{justify-content:flex-end;}
    .chat-bubble-container{display:flex;flex-direction:column;align-items:flex-start;max-width:80%;}
    .chat-message.user .chat-bubble-container{align-items:flex-end;}
    .chat-bubble{padding:12px 16px;border-radius:18px;font-size:14px;line-height:1.5;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.06);}
    .chat-message.user .chat-bubble{background:#dcf8c6;border-bottom-right-radius:0;}
    .chat-message.assistant .chat-bubble{background:#f1f0f0;border-bottom-left-radius:0;}
    .chat-timestamp{font-size:11px;color:#999;margin-top:4px;text-align:right;}
    #suggestions{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:12px;}
    #suggestions .btn-light{background:#fff;border:1px solid #ddd;border-radius:20px;padding:6px 12px;font-size:.85rem;}
    .chat-container{max-height:500px;overflow-y:auto;padding:10px;}

    /* å…¥åŠ› */
    .input-group textarea{resize:none;}
    #sendButton{min-width:70px;}

    /* GPT dots */
    .typing::after{content:'.';animation:dots 1s steps(3,end) infinite;}
    @keyframes dots{0%{content:'';}33%{content:'.';}66%{content:'..';}100%{content:'...';}}
  </style>
</head>

<body>
<!-- ===== ãƒ˜ãƒƒãƒ€ ===== -->
<header id="mainHeader">
  <h1 onclick="navigate('home')">MyCoach</h1>
  <button id="hamburger">â˜°</button>
</header>

<!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="menu">
  <ul>
    <li onclick="navigate('home')">ãƒ›ãƒ¼ãƒ </li>
    <li onclick="navigate('chat')">ãƒˆãƒ¼ã‚¯</li>
    <li onclick="navigate('coach')">æ‹…å½“å¤‰æ›´</li>
    <li onclick="navigate('history')">å±¥æ­´</li>
    <li onclick="navigate('goal-edit')">ç›®æ¨™å¤‰æ›´</li>
    <li onclick="navigate('link')">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</li> <!-- âœ… è¿½åŠ  -->
    <li onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
  </ul>
</div>

<!-- ===== ãƒ¡ã‚¤ãƒ³ ===== -->
<main>
  <!-- ãƒ›ãƒ¼ãƒ  -->
  <div id="home-area" class="card">
    <h4 class="mb-4 text-center">AIã‚³ãƒ¼ãƒãƒ³ã‚°Â ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h4>
    <button class="btn btn-primary w-100 mb-3" onclick="navigate('chat')">ğŸ’¬Â ãƒãƒ£ãƒƒãƒˆã‚’ã¯ã˜ã‚ã‚‹</button>
    <button class="btn btn-success w-100 mb-3" onclick="navigate('coach')">ğŸ‘¨â€ğŸ«Â ã‚³ãƒ¼ãƒã‚’å¤‰æ›´</button>
    <button class="btn btn-secondary w-100"      onclick="navigate('history')">ğŸ“œÂ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¦‹ã‚‹</button>
    <button class="btn btn-outline-secondary w-100" onclick="navigate('goal-edit')">ğŸ¯Â ç›®æ¨™ã‚’å¤‰æ›´</button>
  </div>
  <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº -->
  <div id="link-area" class="card" style="display:none;">
    <h4 class="mb-3">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</h4>
    <input id="linkEmail" class="form-control mb-2" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›" />
    <button class="btn btn-outline-secondary w-100 mb-2" onclick="googleEmailLink()">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" style="height:20px; margin-right:6px;">Google ã¨é€£æº
    </button>
    <button class="btn btn-outline-success w-100" onclick="lineEmailLink()">
      <img src="https://www.svgrepo.com/show/473502/line-line.svg" style="height:20px; margin-right:6px;">LINE ã¨é€£æº
    </button>
    <div id="linkMsg" class="small mt-2 text-danger"></div>
  </div>
    
  <!-- ç›®æ¨™æ–°è¦è¨­å®š -->
  <div id="goal-area" class="card" style="display:none;">
    <h4>ã‚ãªãŸã®ç›®æ¨™ã‚’æ•™ãˆã¦ãã ã•ã„</h4>
    <input type="text" id="goalInput" placeholder="ä¾‹ï¼šTOEICÂ 900ç‚¹ã‚’ç›®æŒ‡ã™" />
    <button class="btn btn-success" onclick="submitGoal()">ç›®æ¨™ã‚’è¨­å®š</button>
  </div>

  <!-- ç›®æ¨™å¤‰æ›´ -->
  <div id="goal-edit-area" class="card" style="display:none;">
    <h4>ç¾åœ¨ã®ç›®æ¨™</h4>
    <p id="currentGoalText" class="mb-3 text-muted">èª­ã¿è¾¼ã¿ä¸­...</p>
    <h5>æ–°ã—ã„ç›®æ¨™ã‚’è¨­å®šã™ã‚‹</h5>
    <input type="text" id="goalEditInput" placeholder="ä¾‹ï¼šTOEICÂ 900ç‚¹ã‚’ç›®æŒ‡ã™" />
    <button class="btn btn-success mt-3" onclick="submitGoalEdit()">å¤‰æ›´ã‚’ä¿å­˜</button>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆ -->
  <div id="chat-area" class="card" style="display:none;">
    <div id="userProfileInfo" class="mb-3 px-3 py-2 border rounded bg-light">
      <div><strong>ğŸ¯Â ç›®æ¨™ï¼š</strong><span id="userGoalText">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><strong>ğŸ‘¨â€ğŸ«Â ã‚³ãƒ¼ãƒï¼š</strong><span id="coachNameText">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>
    <div id="suggestions"></div>
    <div id="chat" class="chat-container"></div>
    <div class="input-group mt-3">
      <textarea id="talkInput" class="form-control" rows="2" placeholder="æ‚©ã¿ã‚„è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰"></textarea>
      <button id="sendButton" class="btn btn-primary" onclick="sendTalk()">é€ä¿¡</button>
    </div>
  </div>

  <!-- ã‚³ãƒ¼ãƒé¸æŠ -->
  <div id="coach-select-area" class="card" style="display:none;">
    <h4>æ‹…å½“ã‚³ãƒ¼ãƒã‚’é¸æŠ</h4>
    <select id="coachSelect"><option value="">--Â é¸æŠã—ã¦ãã ã•ã„Â --</option></select>
    <button class="btn btn-success" onclick="confirmCoach()">ç¢ºå®š</button>
  </div>

  <!-- å±¥æ­´ -->
  <div id="history-area" class="card" style="display:none;">
    <h4 class="text-center mb-3">ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h4>
    <select id="historyFilterSelect" class="form-select mb-3">
      <option value="">â€•â€•Â å…¨ã‚³ãƒ¼ãƒÂ â€•â€•</option>
    </select>
    <div id="historyList" class="chat-history-container"></div>
  </div>
</main>

<!-- ===== SupabaseÂ JSÂ èª­ã¿è¾¼ã¿ ===== -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const supabase = createClient(
    'https://kyxneqqadoyqxsmohbop.supabase.co',
    'PUBLIC_ANON_KEY'          /* â† anon ã‚­ãƒ¼ã«ç½®æ› */
  );
  supabase.auth.onAuthStateChange(async (_event, session) => {
      if (!session?.user) return;

      const sessionEmail = session.user.email?.toLowerCase() || '';
      const pendingEmail = (localStorage.getItem('pendingEmail') || '').toLowerCase();

      if (pendingEmail && pendingEmail !== sessionEmail) {
        alert("Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å…¥åŠ›ã—ãŸãƒ¡ãƒ¼ãƒ«ãŒä¸€è‡´ã—ã¾ã›ã‚“");
        await supabase.auth.signOut();
        return;
      }

      try {
        const res = await fetch(`${API_BASE_URL}/user/oauth_login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ authId: session.user.id, email: sessionEmail })
        });
        const data = await res.json();
        if (res.ok) {
          localStorage.setItem('userId', data.userId);
          localStorage.removeItem('pendingEmail');
          location.href = FRONTEND_HOME;
        } else {
          await supabase.auth.signOut();
          localStorage.removeItem('userId');
          localStorage.removeItem('pendingEmail');
          location.replace('/static/user_login.html');  // âœ… ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸æˆ»ã™
        }
      } catch {
        document.getElementById('linkMsg').textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        await supabase.auth.signOut();
      }
    });
  window.supabase = supabase;
</script>

<!-- ===== ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ ===== -->
<script>
  const API_BASE_URL = 'https://mycoach.onrender.com';
  const LOGIN_PAGE   = '/static/user_login.html';
  const LIFF_ID      = '2007334673-1dVleAwO';            /* â† ã”è‡ªèº«ã® LIFF ID ã«ç½®æ› */

  let userId   = localStorage.getItem('userId') || '';
  let lineId   = localStorage.getItem('lineId') || '';
  let polling  = null;

  /* =========== åˆæœŸãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®š =========== */
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // --- â‘  Supabase ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª ---
      const { data: { session }, error } = await supabase.auth.getSession();
      if (!session) {
      // â‘¡ LINE ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚Œã° LIFF ãƒ•ãƒ­ãƒ¼ã¸
      await liff.init({ liffId: LIFF_ID });
      if (liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        lineId = profile.userId;
        const r = await fetch(`${API_BASE_URL}/user/liff_login`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ lineId })
        });
        if (r.ok) {
          const { userId } = await r.json();
          localStorage.setItem('userId', userId);
          finalizeLogin();
          return;
        }
      }
      // â‘¢ ãƒ­ãƒ¼ã‚«ãƒ«ã« userId ãŒã‚ã‚Œã°ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‰æã§ç¶šè¡Œ
      if (localStorage.getItem('userId')) { finalizeLogin(); return; }
      // â‘£ ã©ã‚Œã‚‚ç„¡ã‘ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
      location.replace('/static/user_login.html');
    }

      if (session?.user) {
        userId = session.user.id;
        localStorage.setItem('userId', userId);  // âœ… å¿˜ã‚Œãšä¿å­˜
        finalizeLogin();
        return;
      }

      // --- â‘¡ LINE LIFF ãƒã‚§ãƒƒã‚¯ ---
      await liff.init({ liffId: LIFF_ID });
      if (liff.isLoggedIn()) {
        const profile = await liff.getProfile();
        lineId = profile.userId;

        const r = await fetch(`${API_BASE_URL}/user/liff_login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lineId })
        });
        const j = await r.json();
        if (r.ok) {
          userId = j.userId;
          localStorage.setItem('lineId', lineId);
          localStorage.setItem('userId', userId);
          finalizeLogin();
          return;
        }
      }

      // --- â‘¢ ä¸¡æ–¹å¤±æ•—ï¼šãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸é·ç§» ---
      location.replace('/static/user_login.html');

    } catch (e) {
      console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', e);
      alert('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
    }
  });


  /* =========== ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œ UI åˆæœŸåŒ– =========== */
  function finalizeLogin(){
    document.getElementById('mainHeader').style.display = 'flex';
    showSection('home');
    loadCoachList();      // âœ… coachä¸€è¦§ã®èª­ã¿è¾¼ã¿
    loadCurrentGoal();
    loadCoachName();
    loadHistory();
  }

  function googleEmailLink(){
      const email = linkEmail.value.trim();
      if (!email) return alert('ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›');
      localStorage.setItem('pendingEmail', email);
      loginWithGoogle();
    }

    async function lineEmailLink() {
      const email = linkEmail.value.trim();
      if (!email) return alert('ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›');
      try {
        await ensureLiffReady();
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: location.href + '?linkEmail=' + encodeURIComponent(email) });
        } else {
          await processLiffProfile(email);
        }
      } catch (e) {
        console.error("LIFFãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‚¨ãƒ©ãƒ¼", e);
      }
    }

    async function ensureLiffReady(){ if(!window.liff || liff.id !== LIFF_ID) await liff.init({ liffId: LIFF_ID }); }

    async function processLiffProfile(forcedEmail){
      try {
        const profile = await liff.getProfile();  // â† ã“ã“ã§ revoked ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
        const lineId  = profile.userId;
        const email   = forcedEmail || new URL(location.href).searchParams.get('linkEmail') || '';
        const endpoint = email ? '/user/liff_link' : '/user/liff_login';
        const body     = email ? { lineId,email } : { lineId };
        const r = await fetch(`${API_BASE_URL}${endpoint}`,{
          method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
        });
        const j = await r.json();
        if(r.ok){
          localStorage.setItem('userId', j.userId);
          location.href = FRONTEND_HOME;
        } else {
          alert(j.error || 'å¤±æ•—');
        }
      } catch (err) {
        console.warn('LIFF access token revoked. Forcing logout and re-login.');
        await liff.logout();
        liff.login({ redirectTo: location.origin + '/index.html' });
      }
    }

  /* =========== ãƒ¡ãƒ¼ãƒ« â†’ Supabase ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦– =========== */
  function startPollingSession(){
    if(polling) return;
    polling = setInterval(async ()=>{
      const { data:{session} } = await supabase.auth.getSession();
      if(session?.user){
        clearInterval(polling);
        userId = session.user.id;
        finalizeLogin();
      }
    }, 1000);
  }
  startPollingSession();   /* â† ã“ã“ã§ç›£è¦–é–‹å§‹ */

  /* --- util: XSS å¯¾ç­– --- */
  const escapeHtml = s => s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  /* ---------------- ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ ---------------- */
  document.getElementById('hamburger').onclick = ()=>{
    const m=document.getElementById('menu');
    m.style.display = (m.style.display==='block') ? 'none' : 'block';
  };
  document.addEventListener('click', e=>{
    if(!e.target.closest('#menu') && e.target.id!=='hamburger'){
      document.getElementById('menu').style.display='none';
    }
  });

  /* ---------------- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---------------- */
  function hideAll(){
    ['home-area','goal-area','goal-edit-area','chat-area','coach-select-area','history-area','link-area']
      .forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
  }
  function showSection(s){
    hideAll();
    const map={home:'home-area',chat:'chat-area',coach:'coach-select-area',
              history:'history-area','goal-edit':'goal-edit-area',goal:'goal-area',link:'link-area'};
    document.getElementById(map[s]).style.display='block';
    if(s==='chat') initSuggestions();
  }
  function navigate(s){document.getElementById('menu').style.display='none';showSection(s);}
  showSection('home');

  /* ---------------- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---------------- */
  function logout(){
  if (!confirm('æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem('userId');
  localStorage.removeItem('lineId');
  localStorage.removeItem('supabase-login-success');

  supabase.auth.signOut().catch(()=>{});
  location.replace('/static/user_login.html');
}

  /* ---------------- ç›®æ¨™è¨­å®šï¼å¤‰æ›´ ---------------- */
  function submitGoal(){
    const goal=document.getElementById('goalInput').value.trim();
    if(!goal)return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    fetch(`${API_BASE_URL}/goal`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId,goal})
    }).then(r=>{
      if(!r.ok) return alert('è¨­å®šå¤±æ•—');
      /* â˜… å³æ™‚åæ˜  */
      document.getElementById('userGoalText').textContent   = goal;
      document.getElementById('currentGoalText').textContent= goal;
      showSection('coach');
    });
  }
  async function submitGoalEdit(){
    const goal=document.getElementById('goalEditInput').value.trim();
    if(!goal)return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    const res=await fetch(`${API_BASE_URL}/goal`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId,goal})
    });
    if(res.ok){
      /* â˜… å³æ™‚åæ˜  */
      document.getElementById('userGoalText').textContent   = goal;
      document.getElementById('currentGoalText').textContent= goal;
      alert('æ›´æ–°ã—ã¾ã—ãŸ');
      showSection('home');
    }else alert('å¤±æ•—');
  }

  /* ---------- ã‚³ãƒ¼ãƒä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰ ---------- */
  async function loadCoachList() {
    const res = await fetch(`${API_BASE_URL}/coaches`);
    const coaches = await res.json();
    const select  = document.getElementById('coachSelect');
    const filter  = document.getElementById('historyFilterSelect');
    coaches.forEach(c=>{
      const txt = `${c.name || '(åç§°æœªè¨­å®š)'}ï¼ˆ${c.code_id}ï¼‰`;
      const opt1=new Option(txt, c.id);
      const opt2=new Option(txt, c.id);
      select.add(opt1); filter.add(opt2);
    });
  }
  window.addEventListener('DOMContentLoaded', loadCoachList);

  /* ---------------- ã‚³ãƒ¼ãƒç¢ºå®š ---------------- */
  function confirmCoach(){
    const sel   = document.getElementById('coachSelect');
    const coachId = sel.value;
    if(!coachId)return alert('é¸æŠã—ã¦ãã ã•ã„');
    fetch(`${API_BASE_URL}/user/assign_coach`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId,coachId})
    }).then(r=>{
      if(!r.ok) return alert('æ›´æ–°å¤±æ•—');
      /* â˜… å³æ™‚åæ˜ ï¼šé¸æŠ option ã®ãƒ©ãƒ™ãƒ«ã‚’ãã®ã¾ã¾è¡¨ç¤º */
      document.getElementById('coachNameText').textContent = sel.options[sel.selectedIndex].text.replace(/ï¼ˆ.*?ï¼‰/,'');
      showSection('chat');
    });
  }

  /* ---------------- ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³ ---------------- */
  let suggestionsShown=false;
  function initSuggestions(){
    if(suggestionsShown) return;
    const sugDiv = document.getElementById('suggestions');
    ['ä»Šé€±ã®é”æˆç›®æ¨™ã‚’æ±ºã‚ãŸã„','ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒè½ã¡ã¦ã„ã¾ã™','å­¦ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœ€é©åŒ–']
      .forEach(text=>{
        const b=document.createElement('button');
        b.className='btn btn-light'; b.textContent=text;
        b.onclick=()=>{document.getElementById('talkInput').value=text; sendTalk();};
        sugDiv.appendChild(b);
      });
    suggestionsShown = true;
  }

  /* ---------------- ãƒãƒ£ãƒƒãƒˆé€ä¿¡ ---------------- */
  function sendTalk(){
    const raw=document.getElementById('talkInput').value;
    const message=raw.trim();
    if(!message)return;
    const chat=document.getElementById('chat');

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ–ãƒ« */
    chat.insertAdjacentHTML('beforeend',`
      <div class="chat-message user">
        <div class="chat-bubble-container">
          <div class="chat-bubble">${escapeHtml(message)}</div>
          <div class="chat-timestamp">${new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}</div>
        </div>
      </div>`);
    document.getElementById('talkInput').value='';

    /* GPTãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    const loadingId='typing-'+Date.now();
    chat.insertAdjacentHTML('beforeend',`
      <div id="${loadingId}" class="chat-message assistant">
        <img src="/Resource/image/Coach_icon/coach_icon_1.png" class="chat-icon" alt="AI">
        <div class="chat-bubble-container"><div class="chat-bubble typing"></div></div>
      </div>`);
    chat.scrollTop = chat.scrollHeight;

    fetch(`${API_BASE_URL}/talk`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId,message})
    })
    .then(r=>r.json())
    .then(d=>{
      document.getElementById(loadingId)?.remove();

      if(d.requireGoal) return alert('ç›®æ¨™è¨­å®šãŒå¿…è¦ã§ã™'), showSection('goal');
      if(d.requireCoach) return alert('ã‚³ãƒ¼ãƒé¸æŠãŒå¿…è¦ã§ã™'), showSection('coach');

      chat.insertAdjacentHTML('beforeend',`
        <div class="chat-message assistant">
          <img src="/Resource/image/Coach_icon/coach_icon_1.png" class="chat-icon" alt="AI">
          <div class="chat-bubble-container">
            <div class="chat-bubble">${escapeHtml(d.message||'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')}</div>
            <div class="chat-timestamp">${new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}</div>
          </div>
        </div>`);
      chat.scrollTop = chat.scrollHeight;
    })
    .catch(e=>{alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼');console.error(e);});
  }

  /* Shift+Enter = æ”¹è¡Œ / Enter = é€ä¿¡ */
  document.getElementById('talkInput').addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendTalk();}
  });

  /* ---------------- å±¥æ­´ ---------------- */
  window.addEventListener('DOMContentLoaded', () => {
  });

  async function loadCurrentGoal(){
    const r = await fetch(`${API_BASE_URL}/user/goal?userId=${userId}`);
    const d = await r.json();
    document.getElementById('userGoalText').textContent   = d.goal || 'æœªè¨­å®š';
    document.getElementById('currentGoalText').textContent= d.goal || 'æœªè¨­å®š';
  }
  async function loadCoachName(){
    const r = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`);
    const d = await r.json();
    if(d.coachId){
      const nameRes = await fetch(`${API_BASE_URL}/coach/profile?coachId=${d.coachId}`);
      const p = await nameRes.json();
      document.getElementById('coachNameText').textContent = p.name || '(æœªè¨­å®š)';
      document.getElementById('coachSelect').value = d.coachId;
    }
  }

  async function loadHistory(){
    if (!userId) return; // â† âœ…ç©ºãªã‚‰å‡¦ç†ä¸­æ­¢
    const sel=document.getElementById('historyFilterSelect');
    const coachId=sel.value||'';
    const qs=new URLSearchParams({userId,coachId});
    const r=await fetch(`${API_BASE_URL}/user/history?${qs}`);
    const list=await r.json();
    const div=document.getElementById('historyList');
    div.innerHTML='';
    list.forEach(m=>{
      div.insertAdjacentHTML('beforeend',`
        <div class="chat-message ${(m.role==='user')?'user':'assistant'}">
          ${m.role==='assistant'?'<img src="/Resource/image/Coach_icon/coach_icon_1.png" class="chat-icon">':''}
          <div class="chat-bubble-container">
            <div class="chat-bubble">${escapeHtml(m.content)}</div>
            <div class="chat-timestamp">${new Date(m.created_at).toLocaleString()}</div>
          </div>
        </div>`);
    });
  }
  document.getElementById('historyFilterSelect').addEventListener('change',loadHistory);
</script>
</body>
</html>
