<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIã‚³ãƒ¼ãƒãƒ³ã‚°Â Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ========= 0. ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ ========= */
    :root{
      --header-h : 64px; 
      --c-bg-grad : linear-gradient(135deg,#ffecd2 0%,#fcb69f 100%);
      --c-card-gl : rgba(255,255,255,.55);
      --c-card-br : rgba(255,255,255,.85);
      --c-txt-prim: #222; --c-txt-sec:#666;
      --c-accent1 : #ff9a9e; --c-accent2:#fae3d9;
      --c-accent3 : #a1c4fd; --c-accent4:#c8e6c9;
      --sh-1:0 8px 24px rgba(0,0,0,.08);
      --sh-in:inset 0 1px 2px rgba(255,255,255,.4);
      font-size:16px;font-family:'Jost','Noto Sans JP',sans-serif;
    }

    /* ========= 1. ãƒ™ãƒ¼ã‚¹ ========= */
    html,body{
      min-height:100%;   /* 100 % â€œä»¥ä¸Šâ€ ã«ä¼¸ã³ã‚‹ã‚ˆã†ã« */
      height:auto;       /* å›ºå®šé«˜ã•ã‚’è§£é™¤ */
      margin:0;
    }
    body{
      padding-top: var(--header-h);
      background:var(--c-bg-grad);background-attachment:fixed;
      color:var(--c-txt-prim);-webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }

    /* ========= 2. ãƒ˜ãƒƒãƒ€ ========= */
    header{
      position:fixed;inset:0 0 auto 0;height:64px;z-index:999;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 24px;backdrop-filter:blur(12px);
    }
    header h1{margin:0;font-size:1.4rem;font-weight:600;cursor:pointer}
    main{
      padding-bottom:80px;   /* æœ€ä¸‹éƒ¨ã«ã‚‚ä½™ç™½ã‚’è¶³ã—ã¦ãŠãã¨
                                ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã‚«ãƒ¼ãƒ‰ã®å½±ãŒåˆ‡ã‚Œãªã„ */
    }
    #hamburger{font-size:1.8rem;background:none;border:none;cursor:pointer}
    #menu{
      position:absolute;top:var(--header-h);right:24px;min-width:160px;display:none;
      background:var(--c-card-gl);backdrop-filter:blur(12px);
      border:1px solid var(--c-card-br);border-radius:16px;box-shadow:var(--sh-1);
      z-index:2000;          /* â† è¿½åŠ  */
    }
    #menu ul{margin:0;padding:8px 0;list-style:none}
    #menu li{
      padding:10px 22px;font-weight:500;cursor:pointer;letter-spacing:.3px;
    }
    #menu li:hover{background:rgba(255,255,255,.35)}

    /* ========= 3. HERO ========= */
    #hero{
      margin-top:24px;          /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã¯ body ã® padding-top ã§ç¢ºä¿æ¸ˆã¿ãªã®ã§è»½ã‚ã« */
      text-align:center;
    }
    #hero img{
      width:190px;height:190px;border-radius:50%;object-fit:cover;
      box-shadow:var(--sh-1),var(--sh-in);
    }
    #hero h2{margin:24px 0 4px;font-size:1.55rem;font-weight:600}
    #hero p{margin:0 auto;max-width:320px;font-size:.95rem;color:var(--c-txt-sec)}

    /* ========= 4. ã‚¬ãƒ©ã‚¹ã‚«ãƒ¼ãƒ‰ ========= */
    .glass-card{
      width:clamp(260px,85%,360px);margin:18px auto;padding:22px 24px;
      display:flex;align-items:center;gap:18px;cursor:pointer;
      border-radius:24px;border:1px solid var(--c-card-br);
      background:var(--c-card-gl);backdrop-filter:blur(14px);
      box-shadow:var(--sh-1);transition:transform .25s,box-shadow .25s;
    }
    .glass-card:hover{transform:translateY(-6px);box-shadow:0 12px 28px rgba(0,0,0,.12)}
    .glass-icon{
      flex:0 0 52px;height:52px;border-radius:18px;font-size:1.45rem;
      display:flex;align-items:center;justify-content:center;color:#fff;
    }
    .grad-1{background:linear-gradient(135deg,#ff9a9e,#fecfef)}
    .grad-2{background:linear-gradient(135deg,#a18cd1,#fbc2eb)}
    .grad-3{background:linear-gradient(135deg,#fbc2eb,#a6c1ee)}
    .grad-4{background:linear-gradient(135deg,#c8e6c9,#a5d6a7)}
    .glass-title{font-size:1.05rem;font-weight:500}

    /* ========= 5. å¾Œæ®µã®ã€Œ.cardã€ (= å„ãƒ•ã‚©ãƒ¼ãƒ ) ========= */
    .card{
      width:clamp(260px,85%,420px);margin:20px auto;padding:28px 24px;
      border-radius:24px;border:1px solid var(--c-card-br);
      background:var(--c-card-gl);backdrop-filter:blur(14px);box-shadow:var(--sh-1);
    }
    .card input,.card textarea,.card select{
      width:100%;padding:10px 14px;border-radius:14px;font-size:1rem;
      border:1px solid #ddd;background:rgba(255,255,255,.86);outline:none;
      transition:border .2s,box-shadow .2s;
    }
    .card input:focus,.card textarea:focus,.card select:focus{
      border-color:var(--c-accent3);box-shadow:0 0 0 3px rgba(161,196,253,.35)
    }
    .card button.btn{border:none;border-radius:9999px;font-weight:600;padding:12px 18px}
    .card .btn-primary{background:var(--c-accent1);color:#fff}
    .card .btn-success{background:#64d9b9;color:#fff}
    .card .btn-outline-success{border:2px solid #64d9b9;background:transparent;color:#64d9b9}

    /* ========= 6. ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ ========= */
    .chat-container,
    .chat-history-container{
      max-height: min(48vh, 540px);
      overflow-y: auto;
      padding: 8px 6px;
      margin-bottom: 12px;
      scroll-behavior: smooth;                /* â† è¿½åŠ ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ»‘ã‚‰ã‹ã« */
    }

    .chat-message{
      display: flex;
      margin: 10px 0;
    }

    .chat-message.user{ justify-content: flex-end; }

    .chat-icon{
      width: 36px; height: 36px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 8px;
      box-shadow: var(--sh-in);
    }

    /* ===== ãƒãƒ–ãƒ« ===== */
    .chat-bubble-container{ max-width: 75%; }

    .chat-bubble{
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.55;
      box-shadow: var(--sh-1);
      word-break: break-word;
      background: #ffffff;                    /* AI ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
    }

    .chat-message.user .chat-bubble{
      background: var(--c-accent2);           /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ãƒ‘ã‚¹ãƒ†ãƒ«è‰² */
      box-shadow: none;
    }

    .chat-timestamp{
      font-size: .75rem;
      color: var(--c-txt-sec);
      margin-top: 4px;
      text-align: right;
    }

    /* ===== å…¥åŠ›ã‚¨ãƒªã‚¢ Glass ä»•ä¸Šã’ ===== */
    .input-group{
      background: var(--c-card-gl);
      border: 1px solid var(--c-card-br);
      backdrop-filter: blur(14px);
      border-radius: 2rem;
      padding: 6px 8px;
      box-shadow: var(--sh-1);
    }

    .input-group textarea{
      resize: none;
      border: none;
      background: transparent;
      outline: none;
    }

    #sendButton{
      border: none;
      background: var(--c-accent1);
      color: #fff;
      border-radius: 50%;
      width: 42px; height: 42px;
      display: flex;
      align-items: center; justify-content: center;
      transition: transform .2s;
    }

    #sendButton:hover{ transform: scale(1.08); }
    #sendButton:active{ transform: scale(.94); }


    /* ========= 7. æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
    .hidden{display:none!important}
    /* ========= 8. ãƒãƒ£ãƒƒãƒˆ â€“ ç›®æ¨™ & ã‚³ãƒ¼ãƒ ã‚¤ãƒ³ãƒ•ã‚©ã‚«ãƒ¼ãƒ‰ ========= */
    #userProfileInfo{
      display: flex;
      flex-direction: column;
      gap: 10px;
      border-radius: 22px;
      padding: 16px 18px;
      margin-bottom: 12px;
      background: var(--c-card-gl);
      backdrop-filter: blur(14px);
      border: 1px solid var(--c-card-br);
      box-shadow: var(--sh-1);
      font-size: .95rem;
    }

    /* å·¦ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰ã‚’å††å½¢ãƒãƒƒã‚¸ã«è¦‹ã›ã‚‹ */
    #userProfileInfo strong{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 30px; height: 30px;
      margin-right: 8px;
      border-radius: 50%;
      font-size: 1rem;
      background: var(--c-accent3);
      color: #fff;
      box-shadow: var(--sh-in);
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã‚’è‡ªç„¶æ”¹è¡Œã•ã›ã¤ã¤è‰²å‘³ã‚’è–„ã‚ã« */
    #userProfileInfo span{
      color: var(--c-txt-sec);
      word-break: break-word;
    }

    /* 1 è¡Œã‚’ flex ã§æ¨ªä¸¦ã³ã« */
    #userProfileInfo div{
      display: flex;
      align-items: center;
    }
    /* === Coach Select ======================================= */
    #coach-select-area .coach-list{
      max-height:min(48vh,520px);           /* ã‚¹ãƒãƒ›ã§ã‚‚ã¯ã¿å‡ºã•ãªã„ */
      overflow-y:auto; padding:2px;
    }

    .coach-item{
      display:flex; align-items:center; gap:14px;
      padding:14px 18px; margin:12px 0;
      border-radius:20px;
      background:var(--c-card-gl);
      backdrop-filter:blur(14px);
      border:1px solid var(--c-card-br);
      box-shadow:var(--sh-1);
      cursor:pointer; transition:transform .2s,box-shadow .2s;
    }
    .coach-item:hover{ transform:translateY(-3px); box-shadow:0 10px 24px rgba(0,0,0,.12); }

    .coach-item.selected{                           /* â† ã‚¯ãƒªãƒƒã‚¯ã§ä»˜ä¸ */
      border:2px solid var(--c-accent3);
      box-shadow:0 0 0 4px rgba(161,196,253,.35);
    }

    .coach-avatar{
      flex:0 0 46px; height:46px; border-radius:50%;
      background:var(--c-accent3);                  /* ç”»åƒãŒç„¡ã„å ´åˆã®è‰² */
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:700; font-size:1.1rem;
      object-fit:cover;
    }

    .coach-info{flex:1}
    .coach-name{font-weight:600}
    .coach-code{font-size:.8rem; color:var(--c-txt-sec)}
    .coach-status{font-size:.8rem; font-weight:600}
    .coach-status.on {color:#2e7d32}
    .coach-status.off{color:#d32f2f}

    /* === History Timeline =================================== */
    #history-area .history-scroll{
      max-height:min(72vh,580px);
      overflow-y:auto; padding:4px 2px;
      scroll-behavior:smooth;
    }

    /* ---- æ—¥ä»˜ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ ---- */
    .date-sep{
      position:sticky; top:0;
      margin:12px 0; padding:6px 12px;
      font-size:.8rem; font-weight:600; letter-spacing:.3px;
      color:#fff;
      background:var(--c-accent3);
      border-radius:14px;
      box-shadow:var(--sh-1);
      z-index:5;
    }

    /* ---- 1 ã¤ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ---- */
    .hist-msg{
      display:flex; gap:10px; margin:12px 0;
      align-items:flex-start;
    }
    .hist-msg.user { flex-direction: row-reverse; } 
    .hist-msg.user .hist-bubble{
      background:var(--c-accent2);
      margin-left:0; 
    }
    .hist-msg.user .hist-time   { text-align: left; } /* æ™‚åˆ»ã‚‚è‡ªç„¶ã«å·¦å¯„ã› */
    .hist-avatar{
      flex:0 0 32px; height:32px; border-radius:50%;
      object-fit:cover; box-shadow:var(--sh-in);
    }
    .hist-bubble{
      max-width:70%; padding:12px 16px;
      border-radius:18px; box-shadow:var(--sh-1);
      background:#fff; word-break:break-word;
      font-size:.92rem; line-height:1.55;
    }
    .hist-msg.user .hist-bubble{
      background:var(--c-accent2);
    }
    .hist-time{
      font-size:.7rem; color:var(--c-txt-sec);
      margin-top:4px; text-align:left;
    }
    .hist-msg.user .hist-time{ text-align:right; } 
  </style>
</head>

<body>
<!-- ===== ãƒ˜ãƒƒãƒ€ ===== -->
<header id="mainHeader">
  <h1 onclick="navigate('home')">MyCoach</h1>
  <button id="hamburger">â˜°</button>
</header>

<!-- ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="menu">
  <ul>
    <li onclick="navigate('home')">ãƒ›ãƒ¼ãƒ </li>
    <li onclick="navigate('chat')">ãƒˆãƒ¼ã‚¯</li>
    <li onclick="navigate('coach')">æ‹…å½“å¤‰æ›´</li>
    <li onclick="navigate('history')">å±¥æ­´</li>
    <li onclick="navigate('goal-edit')">ç›®æ¨™å¤‰æ›´</li>
    <li onclick="navigate('link')">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</li> <!-- âœ… è¿½åŠ  -->
    <li onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</li>
  </ul>
</div>

<!-- ===== ãƒ¡ã‚¤ãƒ³ ===== -->
<main>
  <!-- ãƒ›ãƒ¼ãƒ  -->
<!-- ===== HERO & FUNCTION CARDS ===== -->
<section id="hero">
  <img src="/resource/image/hero_coach_chat.svg" alt="AI Coach">
  <h2>ä¸€ç·’ã«ã€ç†æƒ³ã¸ã€‚</h2>
  <p>ã‚ãªãŸå°‚å±ã® AI ã‚³ãƒ¼ãƒã¨å¯¾è©±ã—ãªãŒã‚‰ã€ã‚´ãƒ¼ãƒ«ã¸ã®æœ€çŸ­ãƒ«ãƒ¼ãƒˆã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã—ã¾ã—ã‚‡ã†ã€‚</p>
</section>

<section id="card-stack">
  <div class="glass-card" onclick="navigate('chat')">
    <div class="glass-icon grad-1">ğŸ’¬</div><span class="glass-title">ãƒãƒ£ãƒƒãƒˆã‚’ã¯ã˜ã‚ã‚‹</span>
  </div>
  <div class="glass-card" onclick="navigate('coach')">
    <div class="glass-icon grad-2">ğŸ‘¨â€ğŸ«</div><span class="glass-title">æ‹…å½“ã‚³ãƒ¼ãƒã‚’å¤‰æ›´</span>
  </div>
  <div class="glass-card" onclick="navigate('history')">
    <div class="glass-icon grad-3">ğŸ“œ</div><span class="glass-title">ãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’è¦‹ã‚‹</span>
  </div>
  <div class="glass-card" onclick="navigate('goal-edit')">
    <div class="glass-icon grad-4">ğŸ¯</div><span class="glass-title">ç›®æ¨™ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</span>
  </div>
</section>
  <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº -->
  <div id="link-area" class="card" style="display:none;">
    <h4 class="mb-3">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº</h4>
    <div id="accountStatus" class="mb-3 text-muted small"></div>
    <!-- <button class="btn btn-outline-secondary w-100 mb-2" onclick="googleEmailLink()">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" style="height:20px; margin-right:6px;">Google ã¨é€£æº
    </button> -->
    <button class="btn btn-outline-success w-100" onclick="lineEmailLink()">
      <img src="/resource/image/line_brand_icon.png" style="height:20px; margin-right:6px;">LINE ã¨é€£æº
    </button>
    <div id="linkMsg" class="small mt-2 text-danger"></div>
  </div>
    
  <!-- ç›®æ¨™æ–°è¦è¨­å®š -->
  <div id="goal-area" class="card" style="display:none;">
    <h4>ã‚ãªãŸã®ç›®æ¨™ã‚’æ•™ãˆã¦ãã ã•ã„</h4>
    <input type="text" id="goalInput" placeholder="ä¾‹ï¼šTOEICÂ 900ç‚¹ã‚’ç›®æŒ‡ã™" />
    <button class="btn btn-success" onclick="submitGoal()">ç›®æ¨™ã‚’è¨­å®š</button>
  </div>

  <!-- ç›®æ¨™å¤‰æ›´ -->
  <div id="goal-edit-area" class="card" style="display:none;">
    <h4>ç¾åœ¨ã®ç›®æ¨™</h4>
    <p id="currentGoalText" class="mb-3 text-muted">èª­ã¿è¾¼ã¿ä¸­...</p>
    <h5>æ–°ã—ã„ç›®æ¨™ã‚’è¨­å®šã™ã‚‹</h5>
    <input type="text" id="goalEditInput" placeholder="ä¾‹ï¼šTOEICÂ 900ç‚¹ã‚’ç›®æŒ‡ã™" />
    <button class="btn btn-success mt-3" onclick="submitGoalEdit()">å¤‰æ›´ã‚’ä¿å­˜</button>
  </div>

  <!-- ãƒãƒ£ãƒƒãƒˆ -->
  <div id="chat-area" class="card" style="display:none;">
    <div id="userProfileInfo" class="mb-3 px-3 py-2 border rounded bg-light">
      <div><strong>ğŸ¯</strong><span id="userGoalText">èª­ã¿è¾¼ã¿ä¸­...</span></div>
      <div><strong>ğŸ‘¨â€ğŸ«</strong><span id="coachNameText" style="font-weight:600;">èª­ã¿è¾¼ã¿ä¸­...</span></div>
    </div>
    <div id="suggestions"></div>
    <div id="chat" class="chat-container"></div>
    <div class="input-group mt-3">
      <textarea id="talkInput" class="form-control" rows="2" placeholder="æ‚©ã¿ã‚„è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
      <button id="sendButton" onclick="sendTalk()">
      <!-- simple plane icon (stroke inherits currentColor) -->
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M3 12L21 3L14 21L12 13L3 12Z" stroke="currentColor"
              stroke-width="2" stroke-linejoin="round"/>
      </svg>
</button>

    </div>
  </div>

  <!-- ã‚³ãƒ¼ãƒé¸æŠ -->
  <div id="coach-select-area" class="card" style="display:none;">
    <h4 class="text-center mb-3">æ‹…å½“ã‚³ãƒ¼ãƒã‚’é¸æŠ</h4>

    <!-- â”€â”€ ã‚³ãƒ¼ãƒä¸€è¦§ï¼ˆJS ã§å‹•çš„ç”Ÿæˆï¼‰ -->
    <div id="coachList" class="coach-list"></div>

    <button id="coachConfirmBtn"
            class="btn btn-success w-100 mt-2"
            disabled>ã“ã®ã‚³ãƒ¼ãƒã«æ±ºå®š</button>
  </div>

  <!-- å±¥æ­´ -->
  <div id="history-area" class="card" style="display:none;">
    <h4 class="text-center mb-3">ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h4>

    <!--â”€ ã‚³ãƒ¼ãƒãƒ•ã‚£ãƒ«ã‚¿ â”€-->
    <select id="historyFilterSelect" class="form-select mb-3">
      <option value="">â€•â€• å…¨ã‚³ãƒ¼ãƒ â€•â€•</option>
    </select>

    <!--â”€ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æœ¬ä½“ â”€-->
    <div id="historyScroll" class="history-scroll"></div>
  </div>

</main>

<!-- ===== SupabaseÂ JSÂ èª­ã¿è¾¼ã¿ ===== -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  const supabase = createClient(
    'https://kyxneqqadoyqxsmohbop.supabase.co',
    'PUBLIC_ANON_KEY'          /* â† anon ã‚­ãƒ¼ã«ç½®æ› */
  );
  supabase.auth.onAuthStateChange(async (_event, session) => {
      if (!session?.user) return;

    const sessionEmail = session.user.email?.toLowerCase() || '';
    const pendingEmail = localStorage.getItem('pendingEmail');

    // âœ… ãƒ¡ãƒ¼ãƒ«é€£æºãƒ•ãƒ­ãƒ¼ã®å ´åˆã ã‘ email ã‚’ç…§åˆ
    if (pendingEmail !== null) {
      if (pendingEmail.toLowerCase() !== sessionEmail) {
        alert("Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨å…¥åŠ›ã—ãŸãƒ¡ãƒ¼ãƒ«ãŒä¸€è‡´ã—ã¾ã›ã‚“");
        await supabase.auth.signOut();
        return;
      }
      // âœ” ä¸€è‡´ or ç…§åˆOKãªã‚‰å‰Šé™¤ã—ã¦å¾Œç¶šå‡¦ç†ã¸
      localStorage.removeItem('pendingEmail');
    }


      try {
        const res = await fetch(`${API_BASE_URL}/user/oauth_login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ authId: session.user.id, email: sessionEmail })
        });
        const data = await res.json();
        if (res.ok) {
          localStorage.setItem('userId', data.userId);
          localStorage.removeItem('pendingEmail');
          location.href = FRONTEND_HOME;
        } else {
          await supabase.auth.signOut();
          localStorage.removeItem('userId');
          localStorage.removeItem('pendingEmail');
          location.replace('/static/user_login.html');  // âœ… ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸æˆ»ã™
        }
      } catch {
        document.getElementById('linkMsg').textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
        await supabase.auth.signOut();
      }
    });
  window.supabase = supabase;
</script>

<!-- ===== ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ ===== -->
<script>
  const API_BASE_URL = 'https://mycoach.onrender.com';
  const LOGIN_PAGE   = '/static/user_login.html';
  const LIFF_ID      = '2007334673-1dVleAwO';            /* â† ã”è‡ªèº«ã® LIFF ID ã«ç½®æ› */

  let userId   = localStorage.getItem('userId') || '';
  let lineId   = localStorage.getItem('lineId') || '';
  let polling  = null;

  /* =========== åˆæœŸãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®š =========== */
  document.addEventListener('DOMContentLoaded', async () => {
  try {
    // â‘  Supabaseã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆGoogleãƒ­ã‚°ã‚¤ãƒ³ç”¨ï¼‰
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user) {
      userId = session.user.id;
      localStorage.setItem('userId', userId);
      finalizeLogin();
      return;
    }

    // â‘¡ LINEãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    await liff.init({ liffId: LIFF_ID });
    if (liff.isLoggedIn()) {
      const profile = await liff.getProfile();
      const lineId = profile.userId;
      const r = await fetch(`${API_BASE_URL}/user/liff_login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lineId })
      });
      const j = await r.json();
      if (r.ok && j.userId) {
        userId = j.userId;
        localStorage.setItem('userId', userId);
        localStorage.setItem('lineId', lineId);
        finalizeLogin();
        return;
      }
    }

    // â‘¢ æœ€å¾Œã®ç ¦ï¼šlocalStorage ã« userId ãŒã‚ã‚Œã°ç¶šè¡Œï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã‚„å¿µã®ãŸã‚ï¼‰
    if (localStorage.getItem('userId')) {
      userId = localStorage.getItem('userId');
      finalizeLogin();
      return;
    }

    // â‘£ ã©ã‚Œã‚‚å¤±æ•— â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã™
    location.replace('/static/user_login.html');

  } catch (e) {
    console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼', e);
    alert('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
  }
});

  /* =========== ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œ UI åˆæœŸåŒ– =========== */
  function finalizeLogin(){
    document.getElementById('mainHeader').style.display = 'flex';
    showSection('home');
    loadCoachList();      // âœ… coachä¸€è¦§ã®èª­ã¿è¾¼ã¿
    loadCurrentGoal();
    loadCoachName();
    loadHistory();
    loadAccountStatus(); // â† ã“ã“ã‚’è¿½åŠ 
  }

  function googleEmailLink(){
      const email = linkEmail.value.trim();
      if (!email) return alert('ãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›');
      localStorage.setItem('pendingEmail', email);
      loginWithGoogle();
    }

    async function lineEmailLink() {
      try {
        await ensureLiffReady();
        if (!liff.isLoggedIn()) {
          liff.login({ redirectUri: location.href });
        } else {
          const profile = await liff.getProfile();
          const lineId = profile.userId;
          const userId = localStorage.getItem('userId');
          const r = await fetch(`${API_BASE_URL}/user/liff_link`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lineId, userId })
          });
          const j = await r.json();
          if (r.ok) {
            alert('LINEã¨é€£æºã—ã¾ã—ãŸï¼');
          } else {
            alert(j.error || 'é€£æºå¤±æ•—');
          }
        }
      } catch (e) {
        console.error("LIFFã‚¨ãƒ©ãƒ¼", e);
      }
    }

    async function loadAccountStatus() {
      const res = await fetch(`${API_BASE_URL}/user/account_status?userId=${userId}`);
      const data = await res.json();

      const googleStatus = '';

      let lineStatus = 'âŒ LINEï¼šæœªé€£æº';
      if (data.lineId) {
        try {
          await ensureLiffReady();
          const profile = await liff.getProfile();
          lineStatus = `âœ… LINEï¼šé€£æºæ¸ˆã¿ï¼ˆ${profile.displayName}ï¼‰`;
        } catch {
          lineStatus = 'âœ… LINEï¼šé€£æºæ¸ˆã¿';
        }
      }

      document.getElementById('accountStatus').innerHTML = `
        <div class="mb-2">${googleStatus}</div>
        <div class="mb-2">${lineStatus}</div>
      `;
    }

    async function ensureLiffReady(){ if(!window.liff || liff.id !== LIFF_ID) await liff.init({ liffId: LIFF_ID }); }

    async function processLiffProfile(forcedEmail){
      try {
        const profile = await liff.getProfile();  // â† ã“ã“ã§ revoked ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
        const lineId  = profile.userId;
        const email   = forcedEmail || new URL(location.href).searchParams.get('linkEmail') || '';
        const endpoint = email ? '/user/liff_link' : '/user/liff_login';
        const body     = email ? { lineId,email } : { lineId };
        const r = await fetch(`${API_BASE_URL}${endpoint}`,{
          method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
        });
        const j = await r.json();
        if(r.ok){
          localStorage.setItem('userId', j.userId);
          location.href = FRONTEND_HOME;
        } else {
          alert(j.error || 'å¤±æ•—');
        }
      } catch (err) {
        console.warn('LIFF access token revoked. Forcing logout and re-login.');
        await liff.logout();
        liff.login({ redirectTo: location.origin + '/index.html' });
      }
    }

  /* =========== ãƒ¡ãƒ¼ãƒ« â†’ Supabase ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦– =========== */
  function startPollingSession(){
    if(polling) return;
    polling = setInterval(async ()=>{
      const { data:{session} } = await supabase.auth.getSession();
      if(session?.user){
        clearInterval(polling);
        userId = session.user.id;
        finalizeLogin();
      }
    }, 1000);
  }
  startPollingSession();   /* â† ã“ã“ã§ç›£è¦–é–‹å§‹ */

  /* --- util: XSS å¯¾ç­– --- */
  const escapeHtml = s => s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  /* ---------------- ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰ ---------------- */
  document.getElementById('hamburger').onclick = ()=>{
    const m=document.getElementById('menu');
    m.style.display = (m.style.display==='block') ? 'none' : 'block';
  };
  document.addEventListener('click', e=>{
    if(!e.target.closest('#menu') && e.target.id!=='hamburger'){
      document.getElementById('menu').style.display='none';
    }
  });

  /* ---------------- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ---------------- */
  function hideAll(){
    [
      'hero','card-stack',          // â† æ–°ãŸã«è¿½åŠ 
      'goal-area','goal-edit-area','chat-area',
      'coach-select-area','history-area','link-area'
    ].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.style.display='none';
    });
  }

  function showSection(s){
    hideAll();

    if (s === 'home'){           // ãƒ›ãƒ¼ãƒ ã¯ HERO + CARD-STACK
      document.getElementById('hero').style.display   = 'block';
      document.getElementById('card-stack').style.display = 'block';
      return;
    }

    const map = {
      chat:'chat-area',
      coach:'coach-select-area',
      history:'history-area',
      'goal-edit':'goal-edit-area',
      goal:'goal-area',
      link:'link-area'
    };
    const el = document.getElementById(map[s]);
    if(el) el.style.display='block';
    if(s === 'chat') initSuggestions();
  }

  function navigate(s){document.getElementById('menu').style.display='none';showSection(s);}
  showSection('home');

  /* ---------------- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---------------- */
  function logout(){
  if (!confirm('æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
  localStorage.removeItem('userId');
  localStorage.removeItem('lineId');
  localStorage.removeItem('supabase-login-success');

  supabase.auth.signOut().catch(()=>{});
  location.replace('/static/user_login.html');
}

  /* ---------------- ç›®æ¨™è¨­å®šï¼å¤‰æ›´ ---------------- */
  function submitGoal(){
    const goal=document.getElementById('goalInput').value.trim();
    if(!goal)return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    fetch(`${API_BASE_URL}/goal`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId,goal})
    }).then(r=>{
      if(!r.ok) return alert('è¨­å®šå¤±æ•—');
      /* â˜… å³æ™‚åæ˜  */
      document.getElementById('userGoalText').textContent   = goal;
      document.getElementById('currentGoalText').textContent= goal;
      showSection('coach');
    });
  }
  async function submitGoalEdit(){
    const goal=document.getElementById('goalEditInput').value.trim();
    if(!goal)return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    const res=await fetch(`${API_BASE_URL}/goal`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId,goal})
    });
    if(res.ok){
      /* â˜… å³æ™‚åæ˜  */
      document.getElementById('userGoalText').textContent   = goal;
      document.getElementById('currentGoalText').textContent= goal;
      alert('æ›´æ–°ã—ã¾ã—ãŸ');
      showSection('home');
    }else alert('å¤±æ•—');
  }

  /* ---------- ã‚³ãƒ¼ãƒä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰ ---------- */
  async function loadCoachList(){
    const res = await fetch(`${API_BASE_URL}/coaches`);
    const coaches = await res.json();
    const listEl  = document.getElementById('coachList');
    listEl.innerHTML = '';                      // åˆæœŸåŒ–
    /* â‘¡ å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— */
    const filterSel = document.getElementById('historyFilterSelect');
    filterSel.innerHTML = '<option value="">â€•â€• å…¨ã‚³ãƒ¼ãƒ â€•â€•</option>';

    coaches.forEach(c=>{
      // ã‚¢ã‚¤ã‚³ãƒ³ãŒç„¡ã„å ´åˆã¯ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«ã‚’å‡ºã™
      const initial = (c.name||'')[0]||'C';

      listEl.insertAdjacentHTML('beforeend',`
        <div class="coach-item" data-id="${c.id}"
            onclick="selectCoach(this)">
          <img class="coach-avatar" src="${c.icon_url||''}"
              onerror="this.outerHTML='<div class=&quot;coach-avatar&quot;>${initial}</div>'">
          <div class="coach-info">
            <div class="coach-name">${c.name||'(åç§°æœªè¨­å®š)'}</div>
            <div class="coach-code">${c.code_id||''}</div>
          </div>
          <div class="coach-status ${c.availability_status?'on':'off'}">
            ${c.availability_status?'å—ä»˜ä¸­':'åœæ­¢ä¸­'}
          </div>
        </div>`);
      /* --- history filter --- */
      const opt   = document.createElement('option');
      opt.value   = c.id;
      opt.textContent = `${c.name||'(åç§°æœªè¨­å®š)'}ï¼ˆ${c.code_id||''}ï¼‰`;
      filterSel.appendChild(opt);
    });
  }


  /* ---------------- ã‚³ãƒ¼ãƒç¢ºå®š ---------------- */
let selectedCoachId = '';

function selectCoach(el){
  // ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é¸æŠçŠ¶æ…‹ã®åˆ‡æ›¿
  document.querySelectorAll('.coach-item.selected')
          .forEach(x=>x.classList.remove('selected'));
  el.classList.add('selected');

  selectedCoachId = el.dataset.id;
  document.getElementById('coachConfirmBtn').disabled = false;
}

document.getElementById('coachConfirmBtn').onclick = async ()=>{
  if(!selectedCoachId) return;
  const r = await fetch(`${API_BASE_URL}/user/assign_coach`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({userId,coachId:selectedCoachId})
  });
  if(r.ok){
    const name = document
        .querySelector(`.coach-item.selected .coach-name`).textContent;
    document.getElementById('coachNameText').textContent = name;
    alert('æ‹…å½“ã‚³ãƒ¼ãƒã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    showSection('chat');
  }else alert('æ›´æ–°å¤±æ•—');
};


  /* ---------------- ã‚µã‚¸ã‚§ã‚¹ãƒãƒ§ãƒ³ ---------------- */
  let suggestionsShown=false;
  function initSuggestions(){
    if(suggestionsShown) return;
    const sugDiv = document.getElementById('suggestions');
    ['ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãŒè½ã¡ã¦ã„ã¾ã™']
      .forEach(text=>{
        const b=document.createElement('button');
        b.className='btn btn-light'; b.textContent=text;
        b.onclick=()=>{document.getElementById('talkInput').value=text; sendTalk();};
        sugDiv.appendChild(b);
      });
    suggestionsShown = true;
  }

  /* ---------------- ãƒãƒ£ãƒƒãƒˆé€ä¿¡ ---------------- */
  function sendTalk(){
    const raw=document.getElementById('talkInput').value;
    const message=raw.trim();
    if(!message)return;
    const chat=document.getElementById('chat');

    /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ–ãƒ« */
    chat.insertAdjacentHTML('beforeend',`
      <div class="chat-message user">
        <div class="chat-bubble-container">
          <div class="chat-bubble">${escapeHtml(message)}</div>
          <div class="chat-timestamp">${new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}</div>
        </div>
      </div>`);
    document.getElementById('talkInput').value='';

    /* GPTãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    const loadingId='typing-'+Date.now();
    chat.insertAdjacentHTML('beforeend',`
      <div id="${loadingId}" class="chat-message assistant">
        <img src="/Resource/image/Coach_icon/coach_icon_1.png" class="chat-icon" alt="AI">
        <div class="chat-bubble-container"><div class="chat-bubble typing"></div></div>
      </div>`);
    chat.scrollTop = chat.scrollHeight;

    fetch(`${API_BASE_URL}/talk`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userId,message})
    })
    .then(r=>r.json())
    .then(d=>{
      document.getElementById(loadingId)?.remove();

      if(d.requireGoal) return alert('ç›®æ¨™è¨­å®šãŒå¿…è¦ã§ã™'), showSection('goal');
      if(d.requireCoach) return alert('ã‚³ãƒ¼ãƒé¸æŠãŒå¿…è¦ã§ã™'), showSection('coach');

      chat.insertAdjacentHTML('beforeend',`
        <div class="chat-message assistant">
          <img src="/Resource/image/Coach_icon/coach_icon_1.png" class="chat-icon" alt="AI">
          <div class="chat-bubble-container">
            <div class="chat-bubble">${escapeHtml(d.message||'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')}</div>
            <div class="chat-timestamp">${new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}</div>
          </div>
        </div>`);
      chat.scrollTop = chat.scrollHeight;
    })
    .catch(e=>{alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼');console.error(e);});
  }

  /* Shift+Enter = æ”¹è¡Œ / Enter = é€ä¿¡ */
  document.getElementById('talkInput').addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendTalk();}
  });

  /* ---------------- å±¥æ­´ ---------------- */
  window.addEventListener('DOMContentLoaded', () => {
  });

  async function loadCurrentGoal(){
    const r = await fetch(`${API_BASE_URL}/user/goal?userId=${userId}`);
    const d = await r.json();
    document.getElementById('userGoalText').textContent   = d.goal || 'æœªè¨­å®š';
    document.getElementById('currentGoalText').textContent= d.goal || 'æœªè¨­å®š';
  }
  async function loadCoachName(){
    const r = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`);
    const d = await r.json();
    if(d.coachId){
      const nameRes = await fetch(`${API_BASE_URL}/coach/profile?coachId=${d.coachId}`);
      const p = await nameRes.json();
      document.getElementById('coachNameText').textContent = p.name || '(æœªè¨­å®š)';
      document.getElementById('coachSelect').value = d.coachId;
    }
  }

  async function loadHistory(){
    if(!userId) return;

    const coachId = document.getElementById('historyFilterSelect').value || '';
    const qs      = new URLSearchParams({userId,coachId});
    const res     = await fetch(`${API_BASE_URL}/user/history?${qs}`);
    const rows    = await res.json();

    const box = document.getElementById('historyScroll');
    box.innerHTML = '';

    let currentDate = '';
    rows.forEach(r=>{
      const d = new Date(r.created_at);
      const dateStr = d.toLocaleDateString('ja-JP',{year:'numeric',month:'short',day:'numeric',weekday:'short'});
      if(dateStr !== currentDate){
        currentDate = dateStr;
        box.insertAdjacentHTML('beforeend',`<div class="date-sep">${currentDate}</div>`);
      }

      const timeStr = d.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
      const isUser  = r.role === 'user';
      const bubble  = `
        <div class="hist-msg ${isUser?'user':'assistant'}">
          ${isUser?'':`<img src="/Resource/image/Coach_icon/coach_icon_1.png" class="hist-avatar">`}
          <div>
            <div class="hist-bubble">${escapeHtml(r.content)}</div>
            <div class="hist-time">${timeStr}</div>
          </div>
        </div>`;
      box.insertAdjacentHTML('beforeend',bubble);
    });

    // ä¸€ç•ªä¸‹ã¾ã§è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰
    box.scrollTop = box.scrollHeight;
  }
  document.getElementById('historyFilterSelect').addEventListener('change',loadHistory);
</script>
</body>
</html>
