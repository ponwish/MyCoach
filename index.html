<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIコーチング 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* 全体 */
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #e0f7fa, #e8f4fd);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
    }
    /* ヘッダー */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    header h1 {
      margin: 0;
      font-size: 1.25rem;
      color: #fff;
    }
    #hamburger {
      font-size: 1.5rem;
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
    }
    /* メニュー */
    #menu {
      position: absolute;
      top: 60px;
      right: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      display: none;
      overflow: hidden;
      z-index: 999;
    }
    #menu ul { padding: 0; margin: 0; list-style: none; }
    #menu li {
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    #menu li:hover { background: #f1f1f1; }

    main {
      padding-top: 80px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      width: 100%;
      max-width: 420px;
      margin: 20px;
      padding: 24px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.08);
    }
    .btn {
      margin-top: 16px;
      border-radius: 30px;
      font-weight: 600;
      padding: 12px;
      transition: background 0.2s, transform 0.2s;
    }
    .btn-primary {
      background: #4facfe;
      border: none;
      color: #fff;
    }
    .btn-primary:hover {
      background: #00f2fe;
      transform: translateY(-2px);
    }
    .btn-success {
      background: #43e97b;
      border: none;
      color: #fff;
    }
    .btn-success:hover {
      background: #38d172;
      transform: translateY(-2px);
    }
    /* チャット */
    .chat-container {
      max-height: 300px;
      overflow-y: auto;
      padding: 12px;
      background: #f8faff;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    #historyList.chat-container {
      max-height: 600px;
    }
    .user-message, .ai-message {
      margin: 8px 0;
      display: flex;
    }
    .user-message span, .ai-message span {
      padding: 10px 16px;
      border-radius: 20px;
      max-width: 75%;
      word-wrap: break-word;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    .user-message span {
      background: #4facfe;
      color: #fff;
      border-radius: 20px 20px 0 20px;
      margin-left: auto;
    }
    .ai-message span {
      background: #e1fcf9;
      color: #333;
      border-radius: 20px 20px 20px 0;
      margin-right: auto;
    }
    #suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 12px;
    }
    #suggestions .btn-light {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 0.85rem;
      transition: background 0.2s;
    }
    #suggestions .btn-light:hover { background: #f0f0f0; }
    /* フォーム */
    input, select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 0 4px rgba(79,172,254,0.5);
    }
  </style>
</head>
<body>
  <header>
    <h1>AIコーチング 2025</h1>
    <button id="hamburger">☰</button>
  </header>

  <div id="menu">
    <ul>
      <li onclick="navigate('chat')">トーク</li>
      <li onclick="navigate('coach')">担当変更</li>
      <li onclick="navigate('history')">履歴</li>
    </ul>
  </div>

  <main>
    <!-- 目標入力 -->
    <div class="card" id="goal-area" style="display:none;">
      <h4>あなたの目標を教えてください</h4>
      <input type="text" id="goalInput" placeholder="例：TOEIC 900点を目指す" />
      <button class="btn btn-success" onclick="submitGoal()">目標を設定</button>
    </div>

    <!-- トーク -->
    <div class="card" id="chat-area" style="display:none;">
      <div id="suggestions"></div>
      <div id="chat" class="chat-container"></div>
      <input type="text" id="talkInput" placeholder="メッセージを入力..." />
      <button class="btn btn-primary" onclick="sendTalk()">送信</button>
    </div>

    <!-- コーチ選択 -->
    <div class="card" id="coach-select-area" style="display:none;">
      <h4>担当コーチを選択</h4>
      <select id="coachSelect">
        <option value="">-- 選択してください --</option>
      </select>
      <button class="btn btn-success" onclick="confirmCoach()">確定</button>
    </div>

    <!-- 履歴 -->
    <div class="card" id="history-area" style="display:none;">
      <h4>トーク履歴</h4>
      <select id="historyFilterSelect">
        <option value="">── 全コーチ ──</option>
      </select>
      <div id="historyList" class="chat-container"></div>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'https://mycoach.onrender.com';
    let userId = '';
    let suggestionsShown = false;
    const suggestionTexts = [
      '目標を確認したい',
      'モチベーションが下がってきた'
    ];

    // LIFF 初期化
    liff.init({ liffId: '2007334673-1dVleAwO' })
      .then(() => !liff.isLoggedIn() ? liff.login() : liff.getProfile())
      .then(profile => { userId = profile.userId; showSection('chat'); })
      .catch(() => showSection('chat'));

    // ハンバーガーメニュー制御
    document.getElementById('hamburger').onclick = () => {
      const m = document.getElementById('menu');
      m.style.display = m.style.display === 'block' ? 'none' : 'block';
    };
    document.addEventListener('click', e => {
      if (!e.target.closest('#menu') && e.target.id !== 'hamburger') {
        document.getElementById('menu').style.display = 'none';
      }
    });

    function navigate(sec) {
      document.getElementById('menu').style.display = 'none';
      showSection(sec);
    }

    function hideAll() {
      ['goal-area','chat-area','coach-select-area','history-area'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    function showSection(sec) {
      hideAll();
      if (sec === 'chat') checkPrerequisites();
      if (sec === 'goal') document.getElementById('goal-area').style.display = 'block';
      if (sec === 'coach') loadCoachChange();
      if (sec === 'history') loadHistory();
    }

    // 目標設定
    function submitGoal() {
      const goal = document.getElementById('goalInput').value.trim();
      if (!goal) return alert('目標を入力してください');
      fetch(`${API_BASE_URL}/goal`, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ userId, goal })
      }).then(r => r.ok ? showSection('coach') : alert('目標設定に失敗しました'));
    }

    // 前提条件チェック
    async function checkPrerequisites() {
      if (!userId) {
        try { const p = await liff.getProfile(); userId = p.userId; } catch {}
      }
      // 目標確認
      let hasGoal = true;
      try { await fetch(`${API_BASE_URL}/user/goal?userId=${userId}`).then(r => { if (!r.ok) throw ''; }); } catch { hasGoal = false; }
      if (!hasGoal) return showSection('goal');
      // コーチ確認
      let hasCoach = true;
      try { await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => { if (!r.ok) throw ''; }); } catch { hasCoach = false; }
      if (!hasCoach) return showSection('coach');
      // トーク画面
      document.getElementById('chat-area').style.display = 'block';
      const sug = document.getElementById('suggestions');
      if (!suggestionsShown) { renderSuggestions(); sug.style.display = 'flex'; suggestionsShown = true; }
      else { sug.style.display = 'none'; }
    }

    // サジェッションチップ
    function renderSuggestions() {
      const c = document.getElementById('suggestions'); c.innerHTML = ''; 
      suggestionTexts.forEach(text => {
        const btn = document.createElement('button'); btn.className = 'btn btn-light btn-sm'; btn.textContent = text;
        btn.onclick = () => { document.getElementById('talkInput').value = text; document.getElementById('talkInput').focus(); };
        c.appendChild(btn);
      });
    }

    // トーク送信
    function sendTalk() {
      document.getElementById('suggestions').style.display = 'none';
      const msg = document.getElementById('talkInput').value; if (!msg) return;
      const chat = document.getElementById('chat');
      const userDiv = document.createElement('div'); userDiv.className = 'user-message'; userDiv.innerHTML = `<span>${msg}</span>`;
      chat.appendChild(userDiv); document.getElementById('talkInput').value = '';
      fetch(`${API_BASE_URL}/talk`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, message: msg })})
        .then(res => res.json()).then(data => {
          if (data.requireGoal) return showSection('goal');
          if (data.requireCoach) return showSection('coach');
          const aiDiv = document.createElement('div'); aiDiv.className = 'ai-message'; aiDiv.innerHTML = `<span>${data.message}</span>`;
          chat.appendChild(aiDiv); chat.scrollTop = chat.scrollHeight;
        });
    }

    // コーチ変更
    async function loadCoachChange() {
      hideAll();
      let mapping;
      try { mapping = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.ok ? r.json() : Promise.reject()); } catch { mapping = null; }
      const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
      const sel = document.getElementById('coachSelect'); sel.innerHTML = '<option value="">-- 選択してください --</option>';
      coaches.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.text = `${c.code_id} ${c.name}`; if (mapping && mapping.coachId === c.id) opt.selected = true; sel.appendChild(opt); });
      document.getElementById('coach-select-area').style.display = 'block';
    }

    function confirmCoach() {
      const coachId = document.getElementById('coachSelect').value; if (!coachId) return alert('コー
