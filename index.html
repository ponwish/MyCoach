<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>コーチングMini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #e8f4fd; min-height: 100vh; padding: 0; margin: 0; font-family: sans-serif; }
    header {
      position: fixed; top: 0; left: 0; right: 0;
      background: #3399ff; color: #fff; height: 50px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 15px; z-index: 2000;
    }
    #hamburger {
      font-size: 24px; background: none; border: none; color: #fff; cursor: pointer;
      z-index: 2001;
    }
    #menu {
      position: absolute; top: 50px; right: 15px; width: 200px;
      background: #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      display: none; z-index: 2000;
    }
    #menu ul { list-style: none; padding: 0; margin: 0; }
    #menu li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    #menu li:hover { background: #f0f0f0; }
    main { padding-top: 60px; display: flex; justify-content: center; }
    .card {
      width: 100%; max-width: 400px; margin: 10px; padding: 20px;
      background: #fff; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .btn { width: 100%; margin-top: 10px; border-radius: 30px; }
    .chat-container {
      max-height: 300px; overflow-y: auto; padding: 10px;
      background: #f9f9f9; border-radius: 8px; margin-bottom: 15px;
    }
    .user-message { text-align: right; margin: 5px 0; }
    .user-message span {
      background: #3399ff; color: #fff; padding: 8px;
      border-radius: 20px 20px 0 20px; display: inline-block;
      max-width: 80%; word-wrap: break-word;
    }
    .ai-message { text-align: left; margin: 5px 0; }
    .ai-message span {
      background: #e0e0e0; color: #333; padding: 8px;
      border-radius: 20px 20px 20px 0; display: inline-block;
      max-width: 80%; word-wrap: break-word;
    }
    #suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 10px; }
    #suggestions .btn-light { font-size: 0.8rem; padding: 5px 10px; }
    #coachSelect, #historyFilterSelect { margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1 style="flex:1; text-align:center; font-size:18px; margin:0;">AIコーチ</h1>
    <button id="hamburger" onclick="toggleMenu()">☰</button>
  </header>

  <div id="menu">
    <ul>
      <li onclick="navigate('chat')">トーク</li>
      <li onclick="navigate('coach')">担当コーチ変更</li>
      <li onclick="navigate('history')">トーク履歴</li>
    </ul>
  </div>

  <main>
    <!-- トーク画面 -->
    <div class="card" id="chat-area" style="display:none;">
      <div id="suggestions"></div>
      <div id="chat" class="chat-container"></div>
      <input type="text" id="talkInput" class="form-control" placeholder="メッセージを入力">
      <button class="btn btn-primary" onclick="sendTalk()">送信</button>
    </div>

    <!-- コーチ変更画面 -->
    <div class="card" id="coach-select-area" style="display:none;">
      <h4>担当コーチを変更</h4>
      <select id="coachSelect" class="form-select">
        <option value="">-- 選択してください --</option>
      </select>
      <button class="btn btn-success" onclick="confirmCoach()">確定</button>
    </div>

    <!-- トーク履歴画面 -->
    <div class="card" id="history-area" style="display:none;">
      <h4>トーク履歴</h4>
      <!-- コーチフィルタ選択 -->
      <select id="historyFilterSelect" class="form-select mb-2">
        <option value="">── 全コーチ ──</option>
      </select>
      <div id="historyList" class="chat-container"></div>
    </div>
  </main>

  <script>
    const API_BASE_URL = 'https://mycoach.onrender.com';
    let userId = '';
    const suggestionTexts = [
      '最近の気分はどうですか？',
      '今日の目標は何ですか？',
      'チャレンジしたいことは？',
      '何でも相談してください'
    ];

    // 初期化
    liff.init({ liffId: '2007334673-1dVleAwO' })
      .then(() => !liff.isLoggedIn() ? liff.login() : liff.getProfile())
      .then(profile => { userId = profile.userId; showSection('chat'); })
      .catch(() => showSection('chat'));

    function toggleMenu() {
      const menu = document.getElementById('menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }
    document.addEventListener('click', e => {
      if (!e.target.closest('#menu') && e.target.id !== 'hamburger') {
        document.getElementById('menu').style.display = 'none';
      }
    });

    function navigate(section) {
      toggleMenu(); showSection(section);
    }
    function hideAll() {
      ['chat-area','coach-select-area','history-area'].forEach(id => document.getElementById(id).style.display = 'none');
    }
    function showSection(section) {
      hideAll();
      if (section === 'chat') { document.getElementById('chat-area').style.display = 'block'; renderSuggestions(); }
      if (section === 'coach') loadCoachChange();
      if (section === 'history') loadHistory();
    }

    function renderSuggestions() {
      const container = document.getElementById('suggestions'); container.innerHTML = '';
      suggestionTexts.forEach(text => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-light btn-sm'; btn.textContent = text;
        btn.onclick = () => { document.getElementById('talkInput').value = text; document.getElementById('talkInput').focus(); };
        container.appendChild(btn);
      });
    }

    function sendTalk() {
      const msg = document.getElementById('talkInput').value; if (!msg) return;
      const chat = document.getElementById('chat');
      const userDiv = document.createElement('div'); userDiv.className = 'user-message'; userDiv.innerHTML = `<span>${msg}</span>`;
      chat.appendChild(userDiv); document.getElementById('talkInput').value = '';
      fetch(`${API_BASE_URL}/talk`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, message: msg })})
        .then(res => res.json()).then(data => {
          const aiDiv = document.createElement('div'); aiDiv.className = 'ai-message'; aiDiv.innerHTML = `<span>${data.message}</span>`;
          chat.appendChild(aiDiv); chat.scrollTop = chat.scrollHeight;
        });
    }

    async function loadCoachChange() {
      hideAll();
      let mapping;
      try { mapping = await fetch(`${API_BASE_URL}/user/coach?userId=${userId}`).then(r => r.ok ? r.json() : Promise.reject()); }
      catch { mapping = null; }
      const coaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
      const sel = document.getElementById('coachSelect'); sel.innerHTML = '<option value="">-- 選択してください --</option>';
      coaches.forEach(c => {
        const opt = document.createElement('option'); opt.value = c.id; opt.text = `${c.code_id} ${c.name}`;
        if (mapping && mapping.coachId === c.id) opt.selected = true;
        sel.appendChild(opt);
      });
      document.getElementById('coach-select-area').style.display = 'block';
    }

    function confirmCoach() {
      const coachId = document.getElementById('coachSelect').value;
      if (!coachId) return alert('コーチを選択してください');
      fetch(`${API_BASE_URL}/user/assign_coach`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId, coachId })})
        .then(res => res.ok && showSection('coach'));
    }

    let cachedCoaches = null;
    
    // 履歴表示機能
    async function loadHistory() {
      hideAll();
      const filterSel = document.getElementById('historyFilterSelect');
      // 初回のみフィルタの選択肢を構築
      if (!cachedCoaches) {
        try {
          cachedCoaches = await fetch(`${API_BASE_URL}/coaches`).then(r => r.json());
        } catch {
          cachedCoaches = [];
        }
        filterSel.innerHTML = '<option value="">── 全コーチ ──</option>';
        cachedCoaches.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.text = `${c.code_id} ${c.name}`;
          filterSel.appendChild(opt);
        });
        // 選択変更時に再読み込み
        filterSel.addEventListener('change', loadHistory);
      }
      // クエリパラメータ設定
      const params = new URLSearchParams({ userId });
      if (filterSel.value) params.append('coachId', filterSel.value);
      let data = [];
      try {
        data = await fetch(`${API_BASE_URL}/user/history?${params}`).then(r => r.json());
      } catch {
        alert('履歴の取得に失敗しました');
      }
      // 表示
      const listEl = document.getElementById('historyList');
      listEl.innerHTML = '';
      data.forEach(msg => {
        const timeDiv = document.createElement('div');
        timeDiv.className = 'text-center text-muted small mb-1';
        timeDiv.textContent = new Date(msg.created_at).toLocaleString('ja-JP', {
          year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'
        });
        listEl.appendChild(timeDiv);
        const bubble = document.createElement('div');
        bubble.className = msg.role === 'user' ? 'user-message' : 'ai-message';
        bubble.innerHTML = `<span>${msg.content}</span>`;
        listEl.appendChild(bubble);
      });
      // 履歴画面表示
      document.getElementById('history-area').style.display = 'block';
    }
  </script>
</body>
</html>
